<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 950 750" width="950" height="750">
  <defs>
    <style>
      .component { fill: #dbeafe; stroke: #1e40af; stroke-width: 2; rx: 4; }
      .memory { fill: #dcfce7; stroke: #16a34a; stroke-width: 2; rx: 4; }
      .control { fill: #fef3c7; stroke: #d97706; stroke-width: 2; rx: 4; }
      .mux { fill: #fce7f3; stroke: #be185d; stroke-width: 1.5; }
      .adder { fill: #e0e7ff; stroke: #4338ca; stroke-width: 1.5; }
      .register { fill: #f3e8ff; stroke: #7c3aed; stroke-width: 1.5; rx: 3; }
      .wire { stroke: #374151; stroke-width: 1.5; fill: none; }
      .bus { stroke: #1e40af; stroke-width: 2.5; fill: none; }
      .addr-bus { stroke: #16a34a; stroke-width: 2; fill: none; }
      .control-wire { stroke: #d97706; stroke-width: 1; fill: none; stroke-dasharray: 3,2; }
      .wb-wire { stroke: #7c3aed; stroke-width: 2; fill: none; }
      .label { font-family: sans-serif; font-size: 9px; fill: #1f2937; }
      .tiny { font-family: sans-serif; font-size: 7px; fill: #6b7280; }
      .component-label { font-family: sans-serif; font-size: 9px; font-weight: bold; fill: #1e40af; }
      .mem-label { font-family: sans-serif; font-size: 9px; font-weight: bold; fill: #166534; }
      .ctrl-label { font-family: sans-serif; font-size: 8px; font-weight: bold; fill: #92400e; }
      .title { font-family: sans-serif; font-size: 14px; font-weight: bold; fill: #1e3a8a; }
      .section { font-family: sans-serif; font-size: 10px; font-weight: bold; fill: #374151; }
    </style>
    <marker id="arrow" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#374151"/>
    </marker>
    <marker id="arrow-blue" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#1e40af"/>
    </marker>
    <marker id="arrow-green" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#16a34a"/>
    </marker>
    <marker id="arrow-purple" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto">
      <polygon points="0 0, 6 2.5, 0 5" fill="#7c3aed"/>
    </marker>
    <marker id="arrow-orange" markerWidth="5" markerHeight="4" refX="5" refY="2" orient="auto">
      <polygon points="0 0, 5 2, 0 4" fill="#d97706"/>
    </marker>
  </defs>

  <!-- Title -->
  <text class="title" x="475" y="22" text-anchor="middle">Architecture du CPU - Data Path Detaille</text>

  <!-- ==================== CONTROL UNIT (top) ==================== -->
  <rect class="control" x="300" y="35" width="350" height="55"/>
  <text class="ctrl-label" x="475" y="52" text-anchor="middle">UNITE DE CONTROLE</text>
  <text class="tiny" x="475" y="65" text-anchor="middle">Decode opcode → Signaux de controle</text>

  <!-- Control signals labels -->
  <text class="tiny" x="320" y="80" fill="#92400e">RegWrite</text>
  <text class="tiny" x="380" y="80" fill="#92400e">MemRead</text>
  <text class="tiny" x="440" y="80" fill="#92400e">MemWrite</text>
  <text class="tiny" x="505" y="80" fill="#92400e">ALUOp</text>
  <text class="tiny" x="555" y="80" fill="#92400e">Branch</text>
  <text class="tiny" x="600" y="80" fill="#92400e">ALUSrc</text>

  <!-- Main CPU boundary -->
  <rect x="20" y="100" width="910" height="540" rx="6" fill="none" stroke="#9ca3af" stroke-width="1" stroke-dasharray="5,5"/>
  <text class="section" x="30" y="118">CPU Data Path</text>

  <!-- ==================== SECTION: INSTRUCTION FETCH ==================== -->
  <rect x="25" y="125" width="200" height="200" fill="#fef9c3" fill-opacity="0.3" stroke="#fbbf24" stroke-width="1" rx="4"/>
  <text class="section" x="125" y="142" text-anchor="middle" fill="#92400e">FETCH</text>

  <!-- PC Register -->
  <rect class="register" x="40" y="160" width="60" height="40"/>
  <text class="component-label" x="70" y="175" text-anchor="middle" fill="#7c3aed">PC</text>
  <text class="tiny" x="70" y="190" text-anchor="middle">32 bits</text>

  <!-- PC Enable signal -->
  <line class="control-wire" x1="70" y1="155" x2="70" y2="160" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="75" y="152" fill="#d97706">PCEn</text>

  <!-- PC+4 Adder -->
  <rect class="adder" x="40" y="220" width="50" height="30"/>
  <text class="tiny" x="65" y="238" text-anchor="middle">PC + 4</text>

  <!-- Branch Target Adder -->
  <rect class="adder" x="115" y="220" width="50" height="30"/>
  <text class="tiny" x="140" y="232" text-anchor="middle">Branch</text>
  <text class="tiny" x="140" y="243" text-anchor="middle">Target</text>

  <!-- PC Source MUX -->
  <polygon points="55,270 85,280 85,310 55,320" class="mux"/>
  <text class="tiny" x="70" y="298" text-anchor="middle" fill="#be185d">MUX</text>
  <text class="tiny" x="45" y="295" text-anchor="end" fill="#be185d">PC</text>

  <!-- MUX select from branch logic -->
  <line class="control-wire" x1="70" y1="325" x2="70" y2="320" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="75" y="332" fill="#d97706">PCSrc</text>

  <!-- Instruction Memory -->
  <rect class="memory" x="130" y="155" width="85" height="55"/>
  <text class="mem-label" x="172" y="175" text-anchor="middle">Instr</text>
  <text class="mem-label" x="172" y="188" text-anchor="middle">Memory</text>
  <text class="tiny" x="172" y="202" text-anchor="middle">ROM 64K</text>

  <!-- PC to InstrMem -->
  <line class="addr-bus" x1="100" y1="180" x2="130" y2="180" marker-end="url(#arrow-green)"/>
  <text class="tiny" x="112" y="175" fill="#16a34a">addr</text>

  <!-- PC to +4 -->
  <line class="wire" x1="70" y1="200" x2="70" y2="220"/>

  <!-- +4 to MUX -->
  <line class="wire" x1="65" y1="250" x2="65" y2="270" marker-end="url(#arrow)"/>
  <text class="tiny" x="52" y="262">+4</text>

  <!-- Branch target to MUX -->
  <path class="wire" d="M 140 250 L 140 260 L 75 260 L 75 270" marker-end="url(#arrow)"/>
  <text class="tiny" x="100" y="258">target</text>

  <!-- MUX to PC -->
  <path class="wire" d="M 55 295 L 30 295 L 30 180 L 40 180" marker-end="url(#arrow)"/>

  <!-- ==================== SECTION: INSTRUCTION DECODE ==================== -->
  <rect x="230" y="125" width="250" height="200" fill="#dcfce7" fill-opacity="0.3" stroke="#22c55e" stroke-width="1" rx="4"/>
  <text class="section" x="355" y="142" text-anchor="middle" fill="#166534">DECODE</text>

  <!-- Instruction Register -->
  <rect class="register" x="240" y="160" width="70" height="35"/>
  <text class="component-label" x="275" y="175" text-anchor="middle" fill="#7c3aed">IR</text>
  <text class="tiny" x="275" y="188" text-anchor="middle">32 bits</text>

  <!-- InstrMem to IR -->
  <line class="bus" x1="215" y1="175" x2="240" y2="175" marker-end="url(#arrow-blue)"/>
  <text class="tiny" x="225" y="168">instr</text>

  <!-- Instruction Fields Decoder -->
  <rect class="component" x="240" y="205" width="90" height="60"/>
  <text class="component-label" x="285" y="222" text-anchor="middle">Decodeur</text>
  <text class="tiny" x="285" y="235" text-anchor="middle">opcode[31:26]</text>
  <text class="tiny" x="285" y="247" text-anchor="middle">rs[25:21]</text>
  <text class="tiny" x="285" y="259" text-anchor="middle">rt[20:16]</text>

  <!-- IR to Decoder -->
  <line class="bus" x1="275" y1="195" x2="275" y2="205" marker-end="url(#arrow-blue)"/>

  <!-- Immediate Extractor -->
  <rect class="component" x="240" y="275" width="90" height="40"/>
  <text class="component-label" x="285" y="292" text-anchor="middle">Imm Ext</text>
  <text class="tiny" x="285" y="305" text-anchor="middle">imm[15:0]→32</text>

  <!-- IR to Imm Ext -->
  <path class="bus" d="M 310 175 L 330 175 L 330 290 L 330 290" marker-end="url(#arrow-blue)"/>

  <!-- Register File -->
  <rect class="component" x="350" y="160" width="120" height="100"/>
  <text class="component-label" x="410" y="180" text-anchor="middle">Banc de Registres</text>
  <text class="tiny" x="410" y="195" text-anchor="middle">32 x 32 bits (R0-R31)</text>

  <!-- Register file ports -->
  <text class="tiny" x="355" y="215">rs (read1)</text>
  <text class="tiny" x="355" y="230">rt (read2)</text>
  <text class="tiny" x="355" y="245">rd (write)</text>
  <line class="wire" x1="350" y1="212" x2="340" y2="212"/>
  <line class="wire" x1="350" y1="227" x2="340" y2="227"/>
  <line class="wire" x1="350" y1="242" x2="340" y2="242"/>

  <!-- Read data outputs -->
  <text class="tiny" x="450" y="215">RD1</text>
  <text class="tiny" x="450" y="235">RD2</text>
  <line class="bus" x1="470" y1="210" x2="485" y2="210" marker-end="url(#arrow-blue)"/>
  <line class="bus" x1="470" y1="230" x2="485" y2="230" marker-end="url(#arrow-blue)"/>

  <!-- Decoder to Register File -->
  <line class="wire" x1="330" y1="220" x2="350" y2="215" marker-end="url(#arrow)"/>
  <line class="wire" x1="330" y1="235" x2="350" y2="230" marker-end="url(#arrow)"/>
  <line class="wire" x1="330" y1="250" x2="350" y2="245" marker-end="url(#arrow)"/>

  <!-- Opcode to Control Unit -->
  <path class="control-wire" d="M 285 205 L 285 100 L 400 100 L 400 90" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="310" y="98" fill="#d97706">opcode</text>

  <!-- RegWrite signal to RegFile -->
  <line class="control-wire" x1="410" y1="155" x2="410" y2="160" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="390" y="152" fill="#d97706">RegWr</text>

  <!-- ==================== SECTION: EXECUTE ==================== -->
  <rect x="485" y="125" width="200" height="200" fill="#dbeafe" fill-opacity="0.3" stroke="#3b82f6" stroke-width="1" rx="4"/>
  <text class="section" x="585" y="142" text-anchor="middle" fill="#1e40af">EXECUTE</text>

  <!-- ALU Source MUX -->
  <polygon points="505,210 535,195 535,235 505,250" class="mux"/>
  <text class="tiny" x="518" y="225" text-anchor="middle" fill="#be185d">MUX</text>
  <text class="tiny" x="500" y="225" text-anchor="end" fill="#be185d">B</text>

  <!-- ALUSrc signal -->
  <line class="control-wire" x1="520" y1="255" x2="520" y2="250" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="525" y="265" fill="#d97706">ALUSrc</text>

  <!-- RD2 to MUX -->
  <path class="bus" d="M 485 230 L 495 230 L 495 235 L 505 235"/>

  <!-- Imm to MUX -->
  <path class="bus" d="M 330 295 L 490 295 L 490 245 L 505 245"/>
  <text class="tiny" x="400" y="290">imm32</text>

  <!-- ALU -->
  <polygon points="555,180 620,200 620,280 555,300 555,180" class="component"/>
  <text class="component-label" x="587" y="235" text-anchor="middle">ALU</text>
  <text class="tiny" x="587" y="250" text-anchor="middle">32-bit</text>

  <!-- ALU Operation labels -->
  <text class="tiny" x="560" y="195">A</text>
  <text class="tiny" x="560" y="285">B</text>

  <!-- RD1 to ALU (A input) -->
  <path class="bus" d="M 485 210 L 530 210 L 530 195 L 555 205" marker-end="url(#arrow-blue)"/>

  <!-- MUX to ALU (B input) -->
  <path class="bus" d="M 535 225 L 545 225 L 545 275 L 555 275" marker-end="url(#arrow-blue)"/>

  <!-- ALU Control -->
  <rect class="control" x="560" y="305" width="55" height="25"/>
  <text class="ctrl-label" x="587" y="320" text-anchor="middle" font-size="7">ALU Ctrl</text>

  <!-- ALUOp to ALU Control -->
  <line class="control-wire" x1="587" y1="90" x2="587" y2="305" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="592" y="150" fill="#d97706">ALUOp</text>

  <!-- ALU Control to ALU -->
  <line class="control-wire" x1="587" y1="300" x2="587" y2="300"/>

  <!-- ALU Result output -->
  <line class="bus" x1="620" y1="240" x2="665" y2="240" marker-end="url(#arrow-blue)"/>
  <text class="tiny" x="630" y="235">Result</text>

  <!-- ALU Flags output -->
  <rect class="register" x="625" y="165" width="50" height="30"/>
  <text class="tiny" x="650" y="178" text-anchor="middle" fill="#7c3aed">Flags</text>
  <text class="tiny" x="650" y="190" text-anchor="middle">N Z C V</text>

  <line class="wire" x1="620" y1="200" x2="625" y2="185" marker-end="url(#arrow)"/>

  <!-- Zero flag to Branch logic -->
  <line class="wire" x1="675" y1="180" x2="700" y2="180"/>

  <!-- ==================== SECTION: MEMORY ACCESS ==================== -->
  <rect x="690" y="125" width="145" height="200" fill="#e0e7ff" fill-opacity="0.3" stroke="#6366f1" stroke-width="1" rx="4"/>
  <text class="section" x="762" y="142" text-anchor="middle" fill="#4338ca">MEMORY</text>

  <!-- Data Memory -->
  <rect class="memory" x="705" y="200" width="85" height="70"/>
  <text class="mem-label" x="747" y="225" text-anchor="middle">Data</text>
  <text class="mem-label" x="747" y="240" text-anchor="middle">Memory</text>
  <text class="tiny" x="747" y="258" text-anchor="middle">RAM 64K</text>

  <!-- Address input -->
  <line class="addr-bus" x1="665" y1="240" x2="705" y2="235" marker-end="url(#arrow-green)"/>
  <text class="tiny" x="680" y="228" fill="#16a34a">addr</text>

  <!-- Write data input -->
  <path class="bus" d="M 485 230 L 495 240 L 495 360 L 720 360 L 720 270" marker-end="url(#arrow-blue)"/>
  <text class="tiny" x="600" y="355">WrData (RD2)</text>

  <!-- Read data output -->
  <line class="bus" x1="790" y1="235" x2="820" y2="235" marker-end="url(#arrow-blue)"/>
  <text class="tiny" x="795" y="228">RdData</text>

  <!-- MemRead/MemWrite signals -->
  <line class="control-wire" x1="747" y1="195" x2="747" y2="200" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="720" y="190" fill="#d97706">MemR</text>
  <text class="tiny" x="755" y="190" fill="#d97706">MemW</text>

  <!-- Branch Logic -->
  <rect class="control" x="700" y="155" width="55" height="30"/>
  <text class="ctrl-label" x="727" y="173" text-anchor="middle" font-size="7">Branch</text>

  <!-- Zero to Branch Logic -->
  <line class="wire" x1="700" y1="180" x2="700" y2="170" marker-end="url(#arrow)"/>

  <!-- Branch signal to Branch Logic -->
  <line class="control-wire" x1="727" y1="150" x2="727" y2="155" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="735" y="148" fill="#d97706">Br</text>

  <!-- Branch Logic output to PC MUX -->
  <path class="control-wire" d="M 700 170 L 700 140 L 180 140 L 180 260 L 155 260 L 155 250" stroke="#d97706"/>
  <text class="tiny" x="400" y="137" fill="#d97706">PCSrc (branch taken)</text>

  <!-- ==================== SECTION: WRITE BACK ==================== -->
  <rect x="840" y="125" width="85" height="200" fill="#fce7f3" fill-opacity="0.3" stroke="#ec4899" stroke-width="1" rx="4"/>
  <text class="section" x="882" y="142" text-anchor="middle" fill="#be185d">WB</text>

  <!-- WB MUX -->
  <polygon points="855,220 885,205 885,255 855,270" class="mux"/>
  <text class="tiny" x="868" y="240" text-anchor="middle" fill="#be185d">MUX</text>
  <text class="tiny" x="850" y="240" text-anchor="end" fill="#be185d">WB</text>

  <!-- MemToReg signal -->
  <line class="control-wire" x1="870" y1="275" x2="870" y2="270" marker-end="url(#arrow-orange)"/>
  <text class="tiny" x="850" y="285" fill="#d97706">MemToReg</text>

  <!-- ALU result to WB MUX -->
  <path class="bus" d="M 665 240 L 680 240 L 680 290 L 840 290 L 840 260 L 855 260"/>
  <text class="tiny" x="760" y="298">ALU Result</text>

  <!-- Mem data to WB MUX -->
  <path class="bus" d="M 820 235 L 840 235 L 840 225 L 855 225"/>

  <!-- WB MUX output -->
  <line class="bus" x1="885" y1="237" x2="905" y2="237"/>

  <!-- ==================== WRITE-BACK PATH ==================== -->
  <path class="wb-wire" d="M 905 237 L 920 237 L 920 640 L 410 640 L 410 260" marker-end="url(#arrow-purple)"/>
  <text class="tiny" x="665" y="650" fill="#7c3aed">Write-Back vers Banc de Registres (rd)</text>

  <!-- ==================== DETAILED CONTROL SIGNALS TABLE ==================== -->
  <rect x="20" y="655" width="910" height="90" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1" rx="5"/>
  <text class="section" x="475" y="672" text-anchor="middle">Signaux de Controle et leur Role</text>

  <!-- Signal descriptions in columns -->
  <rect x="30" y="680" width="140" height="55" fill="#fef3c7" stroke="#d97706" stroke-width="1" rx="3"/>
  <text class="tiny" x="100" y="695" text-anchor="middle" font-weight="bold" fill="#92400e">Fetch</text>
  <text class="tiny" x="35" y="710">PCEn: Active MAJ PC</text>
  <text class="tiny" x="35" y="722">PCSrc: 0=PC+4, 1=Branch</text>

  <rect x="180" y="680" width="140" height="55" fill="#dcfce7" stroke="#22c55e" stroke-width="1" rx="3"/>
  <text class="tiny" x="250" y="695" text-anchor="middle" font-weight="bold" fill="#166534">Decode</text>
  <text class="tiny" x="185" y="710">RegWrite: Ecriture reg</text>
  <text class="tiny" x="185" y="722">RegDst: rd destination</text>

  <rect x="330" y="680" width="150" height="55" fill="#dbeafe" stroke="#3b82f6" stroke-width="1" rx="3"/>
  <text class="tiny" x="405" y="695" text-anchor="middle" font-weight="bold" fill="#1e40af">Execute</text>
  <text class="tiny" x="335" y="710">ALUSrc: 0=reg, 1=imm</text>
  <text class="tiny" x="335" y="722">ALUOp: Operation (ADD,SUB..)</text>

  <rect x="490" y="680" width="140" height="55" fill="#e0e7ff" stroke="#6366f1" stroke-width="1" rx="3"/>
  <text class="tiny" x="560" y="695" text-anchor="middle" font-weight="bold" fill="#4338ca">Memory</text>
  <text class="tiny" x="495" y="710">MemRead: Lecture RAM</text>
  <text class="tiny" x="495" y="722">MemWrite: Ecriture RAM</text>

  <rect x="640" y="680" width="140" height="55" fill="#fce7f3" stroke="#ec4899" stroke-width="1" rx="3"/>
  <text class="tiny" x="710" y="695" text-anchor="middle" font-weight="bold" fill="#be185d">Write-Back</text>
  <text class="tiny" x="645" y="710">MemToReg: 0=ALU, 1=Mem</text>
  <text class="tiny" x="645" y="722">RegWrite: Valide ecriture</text>

  <rect x="790" y="680" width="130" height="55" fill="#fef9c3" stroke="#eab308" stroke-width="1" rx="3"/>
  <text class="tiny" x="855" y="695" text-anchor="middle" font-weight="bold" fill="#a16207">Branch</text>
  <text class="tiny" x="795" y="710">Branch: Instr branchmt</text>
  <text class="tiny" x="795" y="722">Zero: Flag ALU = 0</text>

  <!-- ==================== LEGEND ==================== -->
  <rect x="25" y="340" width="105" height="130" fill="#ffffff" stroke="#e5e7eb" rx="4"/>
  <text class="label" x="77" y="358" text-anchor="middle" font-weight="bold">Legende</text>

  <line x1="35" y1="372" x2="65" y2="372" stroke="#1e40af" stroke-width="2.5"/>
  <text class="tiny" x="70" y="375">Bus donnees</text>

  <line x1="35" y1="390" x2="65" y2="390" stroke="#16a34a" stroke-width="2"/>
  <text class="tiny" x="70" y="393">Bus adresse</text>

  <line x1="35" y1="408" x2="65" y2="408" stroke="#7c3aed" stroke-width="2"/>
  <text class="tiny" x="70" y="411">Write-back</text>

  <line x1="35" y1="426" x2="65" y2="426" stroke="#d97706" stroke-width="1" stroke-dasharray="3,2"/>
  <text class="tiny" x="70" y="429">Controle</text>

  <rect x="35" y="438" width="15" height="10" fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
  <text class="tiny" x="55" y="446">Memoire</text>

  <rect x="35" y="454" width="15" height="10" fill="#f3e8ff" stroke="#7c3aed" stroke-width="1"/>
  <text class="tiny" x="55" y="462">Registre</text>

  <!-- ==================== DATA FLOW ANNOTATIONS ==================== -->
  <text class="tiny" x="172" y="145" fill="#92400e">① Fetch instruction</text>
  <text class="tiny" x="355" y="145" fill="#166534">② Decode + Read regs</text>
  <text class="tiny" x="565" y="145" fill="#1e40af">③ Execute ALU op</text>
  <text class="tiny" x="745" y="145" fill="#4338ca">④ Memory access</text>
  <text class="tiny" x="865" y="145" fill="#be185d">⑤ WB</text>

  <!-- Bus width annotations -->
  <text class="tiny" x="155" y="172" fill="#6b7280">32b</text>
  <text class="tiny" x="225" y="168" fill="#6b7280">32b</text>
  <text class="tiny" x="520" y="205" fill="#6b7280">32b</text>
  <text class="tiny" x="640" y="252" fill="#6b7280">32b</text>
  <text class="tiny" x="810" y="250" fill="#6b7280">32b</text>
</svg>
