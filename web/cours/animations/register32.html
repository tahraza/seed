<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registre 32-bit - Animation Interactive</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .register-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border-radius: 16px;
            margin: 20px 0;
        }
        .value-display {
            font-family: 'Courier New', monospace;
        }
        .decimal-value {
            font-size: 3rem;
            font-weight: bold;
            color: #48bb78;
            margin-bottom: 10px;
        }
        .hex-value {
            font-size: 1.5rem;
            color: #4299e1;
            margin-bottom: 10px;
        }
        .binary-value {
            font-size: 0.9rem;
            color: #a0aec0;
            word-break: break-all;
            text-align: center;
            line-height: 1.5;
        }
        .bit-group {
            display: inline-block;
            margin: 0 5px;
            padding: 2px 5px;
            background: #4a5568;
            border-radius: 4px;
        }
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .input-group {
            background: #2d3748;
            padding: 15px;
            border-radius: 8px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #a0aec0;
            font-size: 14px;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background: #1a202c;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            text-align: center;
        }
        .input-group input:focus {
            border-color: #4299e1;
            outline: none;
        }
        .bit-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            margin: 15px 0;
        }
        .bit-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2d3748;
            border-radius: 4px;
            font-size: 10px;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bit-cell:hover {
            background: #4a5568;
        }
        .bit-cell.on {
            background: #48bb78;
            color: white;
        }
        .clock-btn {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            margin: 10px;
        }
        .clock-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(246, 173, 85, 0.4);
        }
    </style>
</head>
<body>
    <h1>Registre 32-bit</h1>
    <p class="subtitle">32 registres 1-bit en parallele avec signal de chargement commun</p>

    <div class="container">
        <svg class="circuit-svg" viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg">
            <!-- Register bank representation -->
            <rect class="gate-body" x="150" y="40" width="200" height="120" rx="15" stroke="#48bb78" stroke-width="3"/>

            <!-- 32-bit bus input -->
            <path id="wireIn" class="wire on" d="M 50 80 L 150 80" stroke-width="4"/>
            <text x="100" y="70" fill="#718096" font-size="10" text-anchor="middle">[31:0]</text>

            <!-- Load signal -->
            <path id="wireLoad" class="wire off" d="M 50 140 L 150 140"/>

            <!-- Clock -->
            <path id="wireClk" class="wire off" d="M 250 180 L 250 160"/>

            <!-- 32-bit bus output -->
            <path id="wireOut" class="wire on" d="M 350 100 L 450 100" stroke-width="4"/>
            <text x="400" y="90" fill="#718096" font-size="10" text-anchor="middle">[31:0]</text>

            <!-- Input indicator -->
            <rect x="20" y="60" width="60" height="40" rx="8" fill="#4299e1"/>
            <text id="inText" x="50" y="85" text-anchor="middle" fill="white" font-size="12">IN</text>

            <!-- Load toggle -->
            <g class="input-toggle" onclick="toggleLoad()">
                <circle id="loadCircle" cx="50" cy="140" r="18" fill="#e53e3e"/>
                <text x="50" y="145" text-anchor="middle" fill="white" font-weight="bold" font-size="12">L</text>
            </g>

            <!-- Output indicator -->
            <rect x="420" y="80" width="60" height="40" rx="8" fill="#48bb78"/>
            <text id="outText" x="450" y="105" text-anchor="middle" fill="white" font-size="12">OUT</text>

            <!-- Internal bit representation -->
            <g transform="translate(170, 60)">
                <rect x="0" y="0" width="160" height="20" rx="3" fill="#4a5568"/>
                <rect x="0" y="25" width="160" height="20" rx="3" fill="#4a5568"/>
                <rect x="0" y="50" width="160" height="20" rx="3" fill="#4a5568"/>
                <text x="80" y="85" text-anchor="middle" fill="#718096" font-size="10">32 x 1-bit registers</text>
            </g>

            <!-- Labels -->
            <text class="label" x="50" y="50" fill="#4299e1" text-anchor="middle">IN[31:0]</text>
            <text class="label" x="50" y="170" fill="#fc8181" text-anchor="middle">LOAD</text>
            <text class="label label-output" x="450" y="70" text-anchor="middle">OUT[31:0]</text>

            <text x="250" y="30" text-anchor="middle" fill="#a0aec0" font-size="14">REGISTER32</text>
        </svg>

        <div class="register-display">
            <div class="value-display">
                <div class="decimal-value" id="decValue">0</div>
                <div class="hex-value" id="hexValue">0x00000000</div>
                <div class="binary-value" id="binValue">
                    <span class="bit-group">00000000</span>
                    <span class="bit-group">00000000</span>
                    <span class="bit-group">00000000</span>
                    <span class="bit-group">00000000</span>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label>Valeur d'entree (decimal)</label>
                <input type="number" id="inputValue" value="0" onchange="updateInput()">
            </div>
            <div class="input-group">
                <label>Valeur d'entree (hex)</label>
                <input type="text" id="inputHex" value="0" onchange="updateInputHex()">
            </div>
        </div>

        <div style="text-align: center;">
            <button class="clock-btn" onclick="clockPulse()">CLOCK PULSE</button>
            <div style="margin-top: 10px;">
                <label style="color: #a0aec0; cursor: pointer;">
                    <input type="checkbox" id="loadCheck" onchange="toggleLoad()">
                    LOAD active
                </label>
            </div>
        </div>

        <h3 style="text-align: center; color: #a0aec0; margin-top: 20px;">Bits individuels (cliquez pour basculer l'entree)</h3>
        <div class="bit-grid" id="bitGrid"></div>

        <div class="status">
            <div class="status-item">
                <span>IN =</span>
                <span id="statusIn" style="color: #4299e1;">0</span>
            </div>
            <div class="status-item">
                <span>LOAD =</span>
                <span id="statusLoad" class="status-value off">0</span>
            </div>
            <div class="status-item">
                <span>OUT =</span>
                <span id="statusOut" style="color: #48bb78;">0</span>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #2d3748; border-radius: 8px;">
            <p style="color: #a0aec0; margin-bottom: 10px;">Comportement:</p>
            <p style="color: #e2e8f0; font-family: 'Courier New', monospace;">
                if (load) OUT[31:0](t+1) = IN[31:0](t)<br>
                else OUT[31:0](t+1) = OUT[31:0](t)
            </p>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="reset()">Reset</button>
            <button id="animBtn" class="btn btn-primary" onclick="animate()">Demo</button>
        </div>
    </div>

    <nav class="nav" style="margin-top: 20px;">
        <a href="index.html">Index</a>
        <a href="register.html">Registre 1-bit</a>
        <a href="dff.html">DFF</a>
        <a href="ram.html">RAM</a>
    </nav>

    <script>
        let inputValue = 0;
        let outputValue = 0;
        let load = 0;
        let animating = false;

        function toBinary32(n) {
            if (n < 0) n = 0xFFFFFFFF + n + 1;
            return n.toString(2).padStart(32, '0');
        }

        function updateAnimBtn() {
            const btn = document.getElementById('animBtn');
            btn.textContent = animating ? 'Stop' : 'Demo';
            btn.classList.toggle('animating', animating);
        }


        function toHex(n) {
            if (n < 0) n = 0xFFFFFFFF + n + 1;
            return '0x' + n.toString(16).toUpperCase().padStart(8, '0');
        }

        function toggleLoad() {
            load = 1 - load;
            document.getElementById('loadCheck').checked = load === 1;
            updateDisplay();
        }

        function updateInput() {
            inputValue = parseInt(document.getElementById('inputValue').value) || 0;
            inputValue = Math.max(-2147483648, Math.min(2147483647, inputValue));
            document.getElementById('inputValue').value = inputValue;
            document.getElementById('inputHex').value = toHex(inputValue).slice(2);
            updateDisplay();
        }

        function updateInputHex() {
            const hex = document.getElementById('inputHex').value.replace(/[^0-9a-fA-F]/g, '');
            inputValue = parseInt(hex, 16) || 0;
            if (inputValue > 0x7FFFFFFF) inputValue = inputValue - 0x100000000;
            document.getElementById('inputValue').value = inputValue;
            updateDisplay();
        }

        function toggleBit(i) {
            if (animating) return;
            const bit = 1 << (31 - i);
            inputValue ^= bit;
            document.getElementById('inputValue').value = inputValue;
            document.getElementById('inputHex').value = toHex(inputValue).slice(2);
            updateDisplay();
        }

        function renderBitGrid() {
            const grid = document.getElementById('bitGrid');
            grid.innerHTML = '';
            const binary = toBinary32(inputValue);

            for (let i = 0; i < 32; i++) {
                const cell = document.createElement('div');
                cell.className = 'bit-cell' + (binary[i] === '1' ? ' on' : '');
                cell.textContent = binary[i];
                cell.onclick = () => toggleBit(i);
                grid.appendChild(cell);
            }
        }

        async function clockPulse() {
            if (animating) return;

            document.getElementById('wireClk').className.baseVal = 'wire on';

            if (load === 1) {
                outputValue = inputValue;
            }

            updateDisplay();

            await new Promise(r => setTimeout(r, 300));
            document.getElementById('wireClk').className.baseVal = 'wire off';
        }

        function updateDisplay() {
            // Update register display
            document.getElementById('decValue').textContent = outputValue;
            document.getElementById('hexValue').textContent = toHex(outputValue);

            const binary = toBinary32(outputValue);
            document.getElementById('binValue').innerHTML =
                `<span class="bit-group">${binary.slice(0, 8)}</span>` +
                `<span class="bit-group">${binary.slice(8, 16)}</span>` +
                `<span class="bit-group">${binary.slice(16, 24)}</span>` +
                `<span class="bit-group">${binary.slice(24, 32)}</span>`;

            // Update wires
            document.getElementById('wireIn').className.baseVal = 'wire ' + (inputValue !== 0 ? 'on' : 'off');
            document.getElementById('wireLoad').className.baseVal = 'wire ' + (load ? 'on' : 'off');
            document.getElementById('wireOut').className.baseVal = 'wire ' + (outputValue !== 0 ? 'on' : 'off');
            document.getElementById('loadCircle').setAttribute('fill', load ? '#48bb78' : '#e53e3e');

            // Update status
            document.getElementById('statusIn').textContent = inputValue;
            document.getElementById('statusLoad').textContent = load;
            document.getElementById('statusLoad').className = 'status-value ' + (load ? 'on' : 'off');
            document.getElementById('statusOut').textContent = outputValue;

            renderBitGrid();
        }

        function reset() {
            animating = false;
            updateAnimBtn();
            inputValue = 0;
            outputValue = 0;
            load = 0;
            document.getElementById('inputValue').value = 0;
            document.getElementById('inputHex').value = '0';
            document.getElementById('loadCheck').checked = false;
            updateDisplay();
        }

        async function animate() {
            if (animating) {
                animating = false;
                updateAnimBtn();
                return;
            }
            animating = true;
            updateAnimBtn();
            const demos = [
                { input: 0x12345678 },
                { load: true, clock: true },
                { input: 0xDEADBEEF },
                { clock: true },  // load still on
                { load: false },
                { input: 0xCAFEBABE },
                { clock: true },  // no change (load off)
                { load: true, clock: true },  // now it changes
            ];

            for (const action of demos) {
                if (!animating) break;

                if (action.input !== undefined) {
                    inputValue = action.input;
                    document.getElementById('inputValue').value = inputValue;
                    document.getElementById('inputHex').value = toHex(inputValue).slice(2);
                    updateDisplay();
                    await new Promise(r => setTimeout(r, 500));
                }

                if (action.load !== undefined) {
                    load = action.load ? 1 : 0;
                    document.getElementById('loadCheck').checked = load === 1;
                    updateDisplay();
                    await new Promise(r => setTimeout(r, 300));
                }

                if (action.clock) {
                    await clockPulse();
                    await new Promise(r => setTimeout(r, 700));
                }
            }

            animating = false;
            updateAnimBtn();
        }

        updateDisplay();
    </script>
</body>
</html>
