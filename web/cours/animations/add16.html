<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Additionneur 16-bit (Ripple Carry) - Animation Interactive</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .adder-chain {
            display: flex;
            gap: 2px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .full-adder {
            width: 40px;
            height: 60px;
            background: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.3s;
        }
        .full-adder.active {
            border-color: #48bb78;
            background: #276749;
        }
        .full-adder.carry {
            border-color: #f6ad55;
        }
        .full-adder .bit-num {
            font-size: 8px;
            color: #718096;
        }
        .full-adder .fa-label {
            font-weight: bold;
            color: #a0aec0;
        }
        .result-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border-radius: 16px;
            margin: 20px 0;
        }
        .equation {
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            margin: 20px 0;
        }
        .equation .operand {
            color: #4299e1;
        }
        .equation .result {
            color: #48bb78;
        }
        .binary-row {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 5px 0;
            color: #a0aec0;
        }
        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .input-group {
            background: #2d3748;
            padding: 20px;
            border-radius: 10px;
        }
        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: #a0aec0;
            font-size: 14px;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background: #1a202c;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            text-align: center;
        }
        .carry-indicator {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin: 10px 0;
        }
        .carry-bit {
            width: 20px;
            height: 20px;
            background: #4a5568;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #a0aec0;
        }
        .carry-bit.on {
            background: #f6ad55;
            color: white;
        }
        .overflow-warning {
            padding: 10px 20px;
            background: #e53e3e;
            color: white;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .overflow-warning.show {
            display: block;
        }
        .construction-section { margin-top: 30px; border: 2px solid #4a5568; border-radius: 12px; overflow: hidden; }
        .construction-header { background: #2d3748; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .construction-header:hover { background: #4a5568; }
        .construction-header h3 { margin: 0; color: #e2e8f0; font-size: 1.1rem; }
        .construction-toggle { color: #4299e1; font-size: 1.5rem; transition: transform 0.3s; }
        .construction-content { display: none; padding: 20px; background: #1a202c; }
        .construction-content.open { display: block; }
        .construction-toggle.open { transform: rotate(180deg); }
        .construction-formula { text-align: center; padding: 15px; background: #2d3748; border-radius: 8px; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 1.1rem; color: #e2e8f0; }
        .construction-formula .highlight { color: #48bb78; font-weight: bold; }
        .component-links { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        .component-link { padding: 8px 16px; background: #4299e1; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; }
        .component-link:hover { background: #3182ce; }
        .construction-explanation { color: #a0aec0; font-size: 14px; line-height: 1.6; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>Additionneur 16-bit (Ripple Carry)</h1>
    <p class="subtitle">16 Full Adders en cascade avec propagation de la retenue</p>

    <div class="container">
        <svg class="circuit-svg" viewBox="0 0 500 180" xmlns="http://www.w3.org/2000/svg">
            <!-- Input buses -->
            <path id="wireA" class="wire on" d="M 50 50 L 200 50" stroke-width="4"/>
            <path id="wireB" class="wire on" d="M 50 130 L 200 130" stroke-width="4"/>

            <!-- Output bus -->
            <path id="wireSum" class="wire on" d="M 350 90 L 450 90" stroke-width="4"/>

            <!-- Carry out -->
            <path id="wireCout" class="wire off" d="M 350 140 L 450 140"/>

            <!-- Adder block -->
            <rect class="gate-body" x="200" y="30" width="150" height="120" rx="15" stroke="#48bb78" stroke-width="3"/>

            <!-- Internal FA representation -->
            <g transform="translate(215, 55)">
                <rect x="0" y="0" width="20" height="20" rx="3" fill="#4a5568"/>
                <rect x="25" y="0" width="20" height="20" rx="3" fill="#4a5568"/>
                <rect x="50" y="0" width="20" height="20" rx="3" fill="#4a5568"/>
                <rect x="75" y="0" width="20" height="20" rx="3" fill="#4a5568"/>
                <text x="105" y="15" fill="#718096" font-size="12">...</text>
                <text x="60" y="50" text-anchor="middle" fill="#a0aec0" font-size="10">16 Full Adders</text>
            </g>

            <!-- Carry propagation arrow -->
            <path d="M 220 90 L 320 90" stroke="#f6ad55" stroke-width="2" stroke-dasharray="4" fill="none"/>
            <polygon points="320,90 312,86 312,94" fill="#f6ad55"/>

            <!-- Input indicators -->
            <rect x="20" y="35" width="60" height="30" rx="6" fill="#4299e1"/>
            <text x="50" y="55" text-anchor="middle" fill="white" font-size="12">A</text>

            <rect x="20" y="115" width="60" height="30" rx="6" fill="#48bb78"/>
            <text x="50" y="135" text-anchor="middle" fill="white" font-size="12">B</text>

            <!-- Output indicator -->
            <rect x="420" y="75" width="60" height="30" rx="6" fill="#48bb78"/>
            <text x="450" y="95" text-anchor="middle" fill="white" font-size="12">SUM</text>

            <!-- Carry out indicator -->
            <circle id="coutCircle" cx="450" cy="140" r="15" fill="#e53e3e"/>
            <text x="450" y="145" text-anchor="middle" fill="white" font-size="10">C</text>

            <!-- Labels -->
            <text class="label" x="100" y="45" fill="#718096" font-size="10">[15:0]</text>
            <text class="label" x="100" y="125" fill="#718096" font-size="10">[15:0]</text>
            <text class="label" x="380" y="85" fill="#718096" font-size="10">[15:0]</text>

            <text x="275" y="20" text-anchor="middle" fill="#a0aec0" font-size="14">ADD16</text>
        </svg>

        <div class="input-section">
            <div class="input-group">
                <label>A (0 a 65535)</label>
                <input type="number" id="inputA" value="1234" min="0" max="65535" onchange="calculate()">
                <div class="binary-row" id="binA">0000010011010010</div>
            </div>
            <div class="input-group">
                <label>B (0 a 65535)</label>
                <input type="number" id="inputB" value="5678" min="0" max="65535" onchange="calculate()">
                <div class="binary-row" id="binB">0001011000101110</div>
            </div>
        </div>

        <div class="result-display">
            <div class="equation">
                <span class="operand" id="eqA">1234</span>
                <span> + </span>
                <span class="operand" id="eqB">5678</span>
                <span> = </span>
                <span class="result" id="eqResult">6912</span>
            </div>

            <h4 style="color: #a0aec0; margin: 20px 0 10px;">Propagation des retenues</h4>
            <div class="carry-indicator" id="carryIndicator"></div>

            <div class="binary-row" style="font-size: 12px; color: #718096;">
                <div>A: <span id="binAResult">0000010011010010</span></div>
                <div>B: <span id="binBResult">0001011000101110</span></div>
                <div style="border-top: 1px solid #4a5568; margin-top: 5px; padding-top: 5px;">
                    S: <span id="binSum" style="color: #48bb78;">0001101100000000</span>
                </div>
            </div>

            <div class="overflow-warning" id="overflowWarning">
                Depassement! Le resultat depasse 16 bits.
            </div>
        </div>

        <h3 style="text-align: center; color: #a0aec0;">Chaine de Full Adders</h3>
        <div class="adder-chain" id="adderChain"></div>

        <div class="status">
            <div class="status-item">
                <span>A =</span>
                <span id="statusA" style="color: #4299e1;">1234</span>
            </div>
            <div class="status-item">
                <span>B =</span>
                <span id="statusB" style="color: #48bb78;">5678</span>
            </div>
            <div class="status-item">
                <span>SUM =</span>
                <span id="statusSum" style="color: #48bb78;">6912</span>
            </div>
            <div class="status-item">
                <span>Carry =</span>
                <span id="statusCarry" class="status-value off">0</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="reset()">Reset</button>
            <button id="animBtn" class="btn btn-primary" onclick="animate()">Voir Propagation</button>
        </div>

        <!-- Construction Section -->
        <div class="construction-section">
            <div class="construction-header" onclick="toggleConstruction()">
                <h3>Voir la Construction</h3>
                <span class="construction-toggle" id="constructionToggle">&#9660;</span>
            </div>
            <div class="construction-content" id="constructionContent">
                <div class="construction-formula">
                    <span class="highlight">ADD16</span> = 16 x Full Adder en cascade (Ripple Carry)
                </div>

                <p class="construction-explanation">
                    L'additionneur 16-bit utilise 16 Full Adders connectes en cascade.
                    La retenue de sortie de chaque FA devient la retenue d'entree du suivant.
                    C'est l'architecture "Ripple Carry" - simple mais la retenue doit "traverser" tous les etages.
                </p>

                <svg viewBox="0 0 500 100" xmlns="http://www.w3.org/2000/svg" style="max-width: 500px; margin: 0 auto; display: block;">
                    <!-- FA boxes -->
                    <rect x="30" y="30" width="50" height="40" rx="5" fill="#2d3748" stroke="#4299e1" stroke-width="2"/>
                    <text x="55" y="55" text-anchor="middle" fill="#4299e1" font-size="9">FA0</text>

                    <rect x="100" y="30" width="50" height="40" rx="5" fill="#2d3748" stroke="#4299e1" stroke-width="2"/>
                    <text x="125" y="55" text-anchor="middle" fill="#4299e1" font-size="9">FA1</text>

                    <rect x="170" y="30" width="50" height="40" rx="5" fill="#2d3748" stroke="#4299e1" stroke-width="2"/>
                    <text x="195" y="55" text-anchor="middle" fill="#4299e1" font-size="9">FA2</text>

                    <text x="240" y="55" fill="#718096" font-size="14">...</text>

                    <rect x="270" y="30" width="50" height="40" rx="5" fill="#2d3748" stroke="#4299e1" stroke-width="2"/>
                    <text x="295" y="55" text-anchor="middle" fill="#4299e1" font-size="9">FA14</text>

                    <rect x="340" y="30" width="50" height="40" rx="5" fill="#2d3748" stroke="#48bb78" stroke-width="2"/>
                    <text x="365" y="55" text-anchor="middle" fill="#48bb78" font-size="9">FA15</text>

                    <!-- Carry chain -->
                    <path d="M 80 50 L 100 50" stroke="#f6ad55" stroke-width="2" marker-end="url(#arrow)"/>
                    <path d="M 150 50 L 170 50" stroke="#f6ad55" stroke-width="2"/>
                    <path d="M 220 50 L 240 50" stroke="#f6ad55" stroke-width="2" stroke-dasharray="4"/>
                    <path d="M 255 50 L 270 50" stroke="#f6ad55" stroke-width="2" stroke-dasharray="4"/>
                    <path d="M 320 50 L 340 50" stroke="#f6ad55" stroke-width="2"/>
                    <path d="M 390 50 L 420 50" stroke="#f6ad55" stroke-width="2"/>

                    <!-- Cin and Cout -->
                    <text x="10" y="55" fill="#4299e1" font-size="9">Cin=0</text>
                    <circle cx="450" cy="50" r="12" fill="#f6ad55"/>
                    <text x="450" y="54" text-anchor="middle" fill="white" font-size="9">Co</text>

                    <!-- Bit labels -->
                    <text x="55" y="85" text-anchor="middle" fill="#718096" font-size="8">bit 0</text>
                    <text x="125" y="85" text-anchor="middle" fill="#718096" font-size="8">bit 1</text>
                    <text x="195" y="85" text-anchor="middle" fill="#718096" font-size="8">bit 2</text>
                    <text x="295" y="85" text-anchor="middle" fill="#718096" font-size="8">bit 14</text>
                    <text x="365" y="85" text-anchor="middle" fill="#718096" font-size="8">bit 15</text>

                    <!-- A and B inputs -->
                    <text x="55" y="22" text-anchor="middle" fill="#4299e1" font-size="8">A[0] B[0]</text>
                    <text x="365" y="22" text-anchor="middle" fill="#4299e1" font-size="8">A[15] B[15]</text>
                </svg>

                <p class="construction-explanation" style="text-align: center; margin-top: 15px;">
                    <strong>Propagation de la retenue:</strong><br>
                    Cin(i+1) = Cout(i) - chaque FA attend la retenue du precedent<br>
                    Temps total = O(n) - peut etre ameliore avec Carry Lookahead
                </p>

                <div class="component-links">
                    <a href="full-adder.html" class="component-link">Voir Full Adder</a>
                    <a href="half-adder.html" class="component-link">Voir Half Adder</a>
                    <a href="alu.html" class="component-link">Voir ALU</a>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav" style="margin-top: 20px;">
        <a href="index.html">Index</a>
        <a href="full-adder.html">Full Adder</a>
        <a href="half-adder.html">Half Adder</a>
        <a href="alu.html">ALU</a>
    </nav>

    <script>
        let a = 1234;
        let b = 5678;
        let carries = new Array(17).fill(0);
        let animating = false;

        function updateAnimBtn() {
            const btn = document.getElementById('animBtn');
            btn.textContent = animating ? 'Stop' : 'Voir Propagation';
            btn.classList.toggle('animating', animating);
        }


        function toBinary(n, bits = 16) {
            return n.toString(2).padStart(bits, '0');
        }

        function fullAdder(a, b, cin) {
            const sum = (a ^ b ^ cin) & 1;
            const cout = ((a & b) | (a & cin) | (b & cin)) & 1;
            return { sum, cout };
        }

        function add16(a, b) {
            let sum = 0;
            let carry = 0;
            carries = [0];

            for (let i = 0; i < 16; i++) {
                const bitA = (a >> i) & 1;
                const bitB = (b >> i) & 1;
                const result = fullAdder(bitA, bitB, carry);
                sum |= (result.sum << i);
                carry = result.cout;
                carries.push(carry);
            }

            return { sum, carry };
        }

        function calculate() {
            a = parseInt(document.getElementById('inputA').value) || 0;
            a = Math.max(0, Math.min(65535, a));
            document.getElementById('inputA').value = a;

            b = parseInt(document.getElementById('inputB').value) || 0;
            b = Math.max(0, Math.min(65535, b));
            document.getElementById('inputB').value = b;

            const result = add16(a, b);

            // Update displays
            document.getElementById('binA').textContent = toBinary(a);
            document.getElementById('binB').textContent = toBinary(b);
            document.getElementById('binAResult').textContent = toBinary(a);
            document.getElementById('binBResult').textContent = toBinary(b);
            document.getElementById('binSum').textContent = toBinary(result.sum);

            document.getElementById('eqA').textContent = a;
            document.getElementById('eqB').textContent = b;
            document.getElementById('eqResult').textContent = result.sum;

            // Overflow warning
            const overflow = result.carry === 1;
            document.getElementById('overflowWarning').className = 'overflow-warning' + (overflow ? ' show' : '');
            document.getElementById('coutCircle').setAttribute('fill', overflow ? '#f6ad55' : '#e53e3e');

            // Status
            document.getElementById('statusA').textContent = a;
            document.getElementById('statusB').textContent = b;
            document.getElementById('statusSum').textContent = result.sum;
            document.getElementById('statusCarry').textContent = result.carry;
            document.getElementById('statusCarry').className = 'status-value ' + (result.carry ? 'on' : 'off');

            renderCarryIndicator();
            renderAdderChain();
        }

        function renderCarryIndicator() {
            const container = document.getElementById('carryIndicator');
            container.innerHTML = '';

            for (let i = 16; i >= 0; i--) {
                const bit = document.createElement('div');
                bit.className = 'carry-bit' + (carries[i] ? ' on' : '');
                bit.textContent = carries[i];
                bit.title = i === 16 ? 'Cout' : 'C' + i;
                container.appendChild(bit);
            }
        }

        function renderAdderChain(highlightIndex = -1) {
            const chain = document.getElementById('adderChain');
            chain.innerHTML = '';
            const binA = toBinary(a);
            const binB = toBinary(b);
            const result = add16(a, b);
            const binS = toBinary(result.sum);

            for (let i = 15; i >= 0; i--) {
                const fa = document.createElement('div');
                fa.className = 'full-adder';

                if (i === highlightIndex) fa.classList.add('active');
                if (carries[i + 1]) fa.classList.add('carry');

                fa.innerHTML = `
                    <span class="bit-num">bit ${15 - i}</span>
                    <span class="fa-label">FA</span>
                    <span style="color: #4299e1;">${binA[i]}</span>
                    <span style="color: #48bb78;">${binB[i]}</span>
                    <span style="color: #63b3ed;">${binS[i]}</span>
                `;
                chain.appendChild(fa);
            }
        }

        function reset() {
            animating = false;
            updateAnimBtn();
            a = 0;
            b = 0;
            document.getElementById('inputA').value = 0;
            document.getElementById('inputB').value = 0;
            calculate();
        }

        async function animate() {
            if (animating) {
                animating = false;
                updateAnimBtn();
                return;
            }
            animating = true;
            updateAnimBtn();

            // Animate carry propagation
            for (let i = 0; i < 16; i++) {
                if (!animating) break;
                renderAdderChain(15 - i);
                await new Promise(r => setTimeout(r, 200));
            }

            renderAdderChain();
            animating = false;
            updateAnimBtn();
        }

        function toggleConstruction() {
            document.getElementById('constructionContent').classList.toggle('open');
            document.getElementById('constructionToggle').classList.toggle('open');
        }

        // Initialize
        calculate();
    </script>
</body>
</html>
