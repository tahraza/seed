<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFF (Data Flip-Flop) - Animation Interactive</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .timing-diagram {
            background: #1a202c;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .clock-display {
            text-align: center;
            font-size: 3rem;
            margin: 20px 0;
        }
        .clock-indicator {
            display: inline-block;
            padding: 10px 30px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            transition: all 0.2s;
        }
        .clock-high {
            background: #48bb78;
            color: white;
        }
        .clock-low {
            background: #e53e3e;
            color: white;
        }
        .timing-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .timing-label {
            width: 80px;
            color: #a0aec0;
            font-family: 'Courier New', monospace;
        }
        .timing-wave {
            display: flex;
            flex: 1;
        }
        .timing-cell {
            width: 40px;
            height: 30px;
            border-right: 1px solid #4a5568;
            display: flex;
            align-items: flex-end;
        }
        .timing-cell.high {
            background: linear-gradient(to bottom, #48bb78 0%, #48bb78 50%, transparent 50%);
        }
        .timing-cell.low {
            background: linear-gradient(to bottom, transparent 50%, #e53e3e 50%, #e53e3e 100%);
        }
        .timing-cell.rising {
            background: linear-gradient(to top right, #e53e3e 49%, #48bb78 51%);
        }
        .timing-cell.current {
            border: 2px solid #f6ad55;
        }
        .construction-section { margin-top: 30px; border: 2px solid #4a5568; border-radius: 12px; overflow: hidden; }
        .construction-header { background: #2d3748; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .construction-header:hover { background: #4a5568; }
        .construction-header h3 { margin: 0; color: #e2e8f0; font-size: 1.1rem; }
        .construction-toggle { color: #4299e1; font-size: 1.5rem; transition: transform 0.3s; }
        .construction-content { display: none; padding: 20px; background: #1a202c; }
        .construction-content.open { display: block; }
        .construction-toggle.open { transform: rotate(180deg); }
        .construction-formula { text-align: center; padding: 15px; background: #2d3748; border-radius: 8px; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 1rem; color: #e2e8f0; }
        .construction-formula .highlight { color: #48bb78; font-weight: bold; }
        .component-links { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        .component-link { padding: 8px 16px; background: #4299e1; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; }
        .component-link:hover { background: #3182ce; }
        .construction-explanation { color: #a0aec0; font-size: 14px; line-height: 1.6; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>DFF - Data Flip-Flop</h1>
    <p class="subtitle">Element de memoire de base - stocke 1 bit</p>

    <div style="background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); border-radius: 10px; padding: 15px 20px; margin: 20px auto; max-width: 700px; border-left: 4px solid #9f7aea;">
        <p style="color: #e2e8f0; margin: 0 0 10px 0; font-size: 14px;"><strong>Prerequis recommandes:</strong> Pour comprendre le DFF, voyez d'abord comment fonctionne la memoire:</p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="sr-latch.html" style="padding: 8px 16px; background: #4a5568; color: #e2e8f0; text-decoration: none; border-radius: 6px; font-size: 13px;">1. SR Latch (verrou de base)</a>
            <a href="gated-latch.html" style="padding: 8px 16px; background: #4a5568; color: #e2e8f0; text-decoration: none; border-radius: 6px; font-size: 13px;">2. Gated D Latch (+ Enable)</a>
            <span style="padding: 8px 16px; background: #9f7aea; color: white; border-radius: 6px; font-size: 13px;">3. DFF (vous etes ici)</span>
        </div>
    </div>

    <div class="container">
        <p class="instructions">Cliquez sur D pour changer l'entree, puis sur CLK pour capturer la valeur</p>

        <svg class="circuit-svg" viewBox="0 0 450 220" xmlns="http://www.w3.org/2000/svg">
            <!-- DFF box -->
            <rect class="gate-body" x="150" y="50" width="150" height="120" rx="10" stroke-width="3"/>

            <!-- Clock triangle -->
            <polygon points="150,140 170,150 150,160" fill="#4a5568" stroke="#a0aec0"/>

            <!-- Input D wire -->
            <path id="wireD" class="wire off" d="M 50 90 L 150 90"/>

            <!-- Clock wire -->
            <path id="wireClk" class="wire off" d="M 50 150 L 150 150"/>

            <!-- Output Q wire -->
            <path id="wireQ" class="wire off" d="M 300 110 L 400 110"/>

            <!-- Input D toggle -->
            <g class="input-toggle" onclick="toggleD()">
                <circle id="inputD" cx="50" cy="90" r="22" fill="#e53e3e"/>
                <text id="inputDText" x="50" y="96" text-anchor="middle" fill="white" font-weight="bold" font-size="18">0</text>
            </g>

            <!-- Clock toggle -->
            <g class="input-toggle" onclick="clockPulse()">
                <rect id="clockBtn" x="28" y="128" width="44" height="44" rx="8" fill="#4299e1"/>
                <text x="50" y="155" text-anchor="middle" fill="white" font-weight="bold" font-size="12">CLK</text>
            </g>

            <!-- Output Q indicator -->
            <circle id="outputQ" cx="400" cy="110" r="22" fill="#e53e3e"/>
            <text id="outputQText" x="400" y="116" text-anchor="middle" fill="white" font-weight="bold" font-size="18">0</text>

            <!-- Labels -->
            <text class="label label-input" x="50" y="55">D (data)</text>
            <text class="label" x="50" y="190" fill="#4299e1">Clock</text>
            <text class="label label-output" x="400" y="75">Q (output)</text>

            <!-- Internal labels -->
            <text x="165" y="98" fill="#718096" font-size="12">D</text>
            <text x="280" y="118" fill="#718096" font-size="12">Q</text>
            <text x="165" y="158" fill="#718096" font-size="12">CLK</text>

            <text x="225" y="115" text-anchor="middle" fill="#a0aec0" font-size="14">DFF</text>
        </svg>

        <div class="clock-display">
            <div class="clock-indicator" id="clockIndicator">
                <span id="clockState">IDLE</span>
            </div>
        </div>

        <div class="status">
            <div class="status-item">
                <span>D (entree) =</span>
                <span id="statusD" class="status-value off">0</span>
            </div>
            <div class="status-item">
                <span>Q (sortie) =</span>
                <span id="statusQ" class="status-value off">0</span>
            </div>
        </div>

        <h3 style="text-align: center; margin-top: 30px; color: #a0aec0;">Diagramme Temporel</h3>
        <div class="timing-diagram">
            <div class="timing-row">
                <span class="timing-label">CLK</span>
                <div class="timing-wave" id="clkWave"></div>
            </div>
            <div class="timing-row">
                <span class="timing-label">D</span>
                <div class="timing-wave" id="dWave"></div>
            </div>
            <div class="timing-row">
                <span class="timing-label">Q</span>
                <div class="timing-wave" id="qWave"></div>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #2d3748; border-radius: 8px;">
            <p style="color: #a0aec0; margin-bottom: 10px;">Comportement du DFF:</p>
            <p style="color: #e2e8f0; font-family: 'Courier New', monospace;">
                Q(t+1) = D(t) <span style="color: #718096;">// La sortie prend la valeur de D au front montant</span>
            </p>
        </div>

        <table class="truth-table">
            <thead>
                <tr>
                    <th>CLK</th>
                    <th>D</th>
                    <th>Q (apres)</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>0</td><td>X</td><td>Q</td><td>Pas de changement (horloge basse)</td></tr>
                <tr><td>↑</td><td>0</td><td>0</td><td>Front montant: memorise 0</td></tr>
                <tr><td>↑</td><td>1</td><td>1</td><td>Front montant: memorise 1</td></tr>
                <tr><td>1</td><td>X</td><td>Q</td><td>Pas de changement (horloge haute)</td></tr>
            </tbody>
        </table>

        <div class="controls">
            <button class="btn btn-secondary" onclick="reset()">Reset</button>
            <button id="animBtn" class="btn btn-primary" onclick="animate()">Animation Auto</button>
        </div>

        <!-- Construction Section -->
        <div class="construction-section">
            <div class="construction-header" onclick="toggleConstruction()">
                <h3>Voir la Construction</h3>
                <span class="construction-toggle" id="constructionToggle">&#9660;</span>
            </div>
            <div class="construction-content" id="constructionContent">
                <div class="construction-formula">
                    <span class="highlight">DFF</span> = 2 × Gated D Latch (Master + Slave) avec horloges inversees
                </div>

                <div style="background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p class="construction-explanation" style="margin: 0;">
                        <strong style="color: #f6ad55;">Pourquoi le DFF?</strong> Le <a href="gated-latch.html" style="color: #4299e1;">Gated D Latch</a> a un probleme:
                        quand Enable=1, il est "transparent" - les changements de D passent directement a Q.
                        Dans un circuit synchrone, ca cree des courses (race conditions) car un signal peut traverser plusieurs latches en un seul cycle.
                    </p>
                </div>

                <p class="construction-explanation">
                    <strong>Solution Master-Slave:</strong> On enchaine 2 latches avec des signaux Enable <em>opposes</em>.
                    Quand CLK=0, le Master capture D mais le Slave est ferme.
                    Quand CLK=1, le Master est ferme et le Slave copie ce que le Master a capture.
                    Resultat: Q ne change qu'au moment precis du front montant!
                </p>

                <svg viewBox="0 0 520 180" xmlns="http://www.w3.org/2000/svg" style="max-width: 520px; margin: 0 auto; display: block;">
                    <!-- Master latch -->
                    <rect x="100" y="30" width="100" height="70" rx="8" fill="#2d3748" stroke="#4299e1" stroke-width="2"/>
                    <text x="150" y="55" text-anchor="middle" fill="#4299e1" font-size="12" font-weight="bold">MASTER</text>
                    <text x="150" y="72" text-anchor="middle" fill="#718096" font-size="10">(Gated D Latch)</text>
                    <text x="150" y="88" text-anchor="middle" fill="#f6ad55" font-size="9">E = NOT(CLK)</text>

                    <!-- Slave latch -->
                    <rect x="280" y="30" width="100" height="70" rx="8" fill="#2d3748" stroke="#48bb78" stroke-width="2"/>
                    <text x="330" y="55" text-anchor="middle" fill="#48bb78" font-size="12" font-weight="bold">SLAVE</text>
                    <text x="330" y="72" text-anchor="middle" fill="#718096" font-size="10">(Gated D Latch)</text>
                    <text x="330" y="88" text-anchor="middle" fill="#f6ad55" font-size="9">E = CLK</text>

                    <!-- D input -->
                    <path class="wire off" d="M 40 55 L 100 55" stroke-width="3"/>
                    <circle cx="40" cy="55" r="14" fill="#e53e3e"/>
                    <text x="40" y="60" text-anchor="middle" fill="white" font-size="11" font-weight="bold">D</text>

                    <!-- Master to Slave wire -->
                    <path class="wire on" d="M 200 65 L 280 65" stroke-width="3"/>

                    <!-- Q output -->
                    <path class="wire on" d="M 380 65 L 480 65" stroke-width="3"/>
                    <circle cx="480" cy="65" r="14" fill="#48bb78"/>
                    <text x="480" y="70" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Q</text>

                    <!-- Clock input -->
                    <circle cx="40" cy="140" r="14" fill="#4299e1"/>
                    <text x="40" y="145" text-anchor="middle" fill="white" font-size="9" font-weight="bold">CLK</text>

                    <!-- Clock to NOT -->
                    <path class="wire off" d="M 54 140 L 130 140" stroke-width="2"/>

                    <!-- NOT gate -->
                    <polygon points="130,132 130,148 150,140" fill="#2d3748" stroke="#f6ad55" stroke-width="2"/>
                    <circle cx="153" cy="140" r="4" fill="none" stroke="#f6ad55" stroke-width="2"/>

                    <!-- NOT CLK to Master -->
                    <path class="wire on" d="M 157 140 L 170 140 L 170 100 L 150 100" stroke-width="2"/>
                    <circle cx="150" cy="100" r="4" fill="#f6ad55"/>

                    <!-- CLK to Slave -->
                    <path class="wire off" d="M 130 140 L 130 155 L 350 155 L 350 100 L 330 100" stroke-width="2"/>
                    <circle cx="330" cy="100" r="4" fill="#4299e1"/>

                    <!-- State annotations -->
                    <text x="150" y="18" fill="#4299e1" font-size="9" text-anchor="middle">Ouvert quand CLK=0</text>
                    <text x="330" y="18" fill="#48bb78" font-size="9" text-anchor="middle">Ouvert quand CLK=1</text>
                </svg>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <div style="background: #1e3a5f; padding: 12px; border-radius: 8px; border-left: 3px solid #4299e1;">
                        <p style="color: #4299e1; font-weight: bold; margin: 0 0 5px 0; font-size: 13px;">CLK = 0 (bas)</p>
                        <p style="color: #a0aec0; margin: 0; font-size: 12px;">
                            Master OUVERT → capture D<br>
                            Slave FERME → maintient Q
                        </p>
                    </div>
                    <div style="background: #1e4a3f; padding: 12px; border-radius: 8px; border-left: 3px solid #48bb78;">
                        <p style="color: #48bb78; font-weight: bold; margin: 0 0 5px 0; font-size: 13px;">CLK = 1 (haut)</p>
                        <p style="color: #a0aec0; margin: 0; font-size: 12px;">
                            Master FERME → maintient<br>
                            Slave OUVERT → copie Master → Q
                        </p>
                    </div>
                </div>

                <p class="construction-explanation" style="text-align: center; margin-top: 15px; padding: 10px; background: #2d3748; border-radius: 8px;">
                    <strong style="color: #48bb78;">Resultat:</strong> Q change uniquement au <strong>front montant</strong> (0→1) de CLK.<br>
                    C'est cette propriete qui rend les circuits synchrones fiables!
                </p>

                <div class="component-links">
                    <a href="sr-latch.html" class="component-link">Voir SR Latch</a>
                    <a href="gated-latch.html" class="component-link">Voir Gated D Latch</a>
                    <a href="register.html" class="component-link">Voir Registre</a>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav" style="margin-top: 20px;">
        <a href="index.html">Index</a>
        <a href="sr-latch.html">SR Latch</a>
        <a href="gated-latch.html">Gated D Latch</a>
        <a href="register.html">Registre 1-bit</a>
        <a href="ram.html">RAM</a>
    </nav>

    <script>
        let d = 0;
        let q = 0;
        let history = [];
        let animating = false;
        const maxHistory = 12;

        function updateAnimBtn() {
            const btn = document.getElementById('animBtn');
            btn.textContent = animating ? 'Stop' : 'Animation Auto';
            btn.classList.toggle('animating', animating);
        }


        function toggleD() {
            if (animating) return;
            d = 1 - d;
            updateDisplay();
        }

        function clockPulse() {
            if (animating) return;
            performClockPulse();
        }

        async function performClockPulse() {
            // Rising edge - capture D
            const indicator = document.getElementById('clockIndicator');
            const clockBtn = document.getElementById('clockBtn');

            indicator.className = 'clock-indicator clock-high';
            document.getElementById('clockState').textContent = 'RISING ↑';
            clockBtn.setAttribute('fill', '#48bb78');
            document.getElementById('wireClk').className.baseVal = 'wire on';

            // Capture value on rising edge
            q = d;

            // Add to history
            history.push({ clk: 'rising', d: d, q: q });
            if (history.length > maxHistory) history.shift();

            updateDisplay();
            updateTimingDiagram();

            await new Promise(r => setTimeout(r, 300));

            // High state
            document.getElementById('clockState').textContent = 'HIGH';
            history.push({ clk: 'high', d: d, q: q });
            if (history.length > maxHistory) history.shift();
            updateTimingDiagram();

            await new Promise(r => setTimeout(r, 300));

            // Falling edge
            indicator.className = 'clock-indicator clock-low';
            document.getElementById('clockState').textContent = 'LOW';
            clockBtn.setAttribute('fill', '#4299e1');
            document.getElementById('wireClk').className.baseVal = 'wire off';

            history.push({ clk: 'low', d: d, q: q });
            if (history.length > maxHistory) history.shift();
            updateTimingDiagram();
        }

        function updateDisplay() {
            // Update D input
            document.getElementById('inputD').setAttribute('fill', d ? '#48bb78' : '#e53e3e');
            document.getElementById('inputDText').textContent = d;
            document.getElementById('wireD').className.baseVal = 'wire ' + (d ? 'on' : 'off');

            // Update Q output
            document.getElementById('outputQ').setAttribute('fill', q ? '#48bb78' : '#e53e3e');
            document.getElementById('outputQText').textContent = q;
            document.getElementById('wireQ').className.baseVal = 'wire ' + (q ? 'on' : 'off');

            // Update status
            document.getElementById('statusD').textContent = d;
            document.getElementById('statusD').className = 'status-value ' + (d ? 'on' : 'off');
            document.getElementById('statusQ').textContent = q;
            document.getElementById('statusQ').className = 'status-value ' + (q ? 'on' : 'off');
        }

        function updateTimingDiagram() {
            const clkWave = document.getElementById('clkWave');
            const dWave = document.getElementById('dWave');
            const qWave = document.getElementById('qWave');

            clkWave.innerHTML = '';
            dWave.innerHTML = '';
            qWave.innerHTML = '';

            history.forEach((h, i) => {
                const isCurrent = i === history.length - 1;

                // Clock
                const clkCell = document.createElement('div');
                clkCell.className = 'timing-cell ' +
                    (h.clk === 'high' ? 'high' : h.clk === 'rising' ? 'rising' : 'low') +
                    (isCurrent ? ' current' : '');
                clkWave.appendChild(clkCell);

                // D
                const dCell = document.createElement('div');
                dCell.className = 'timing-cell ' + (h.d ? 'high' : 'low') + (isCurrent ? ' current' : '');
                dWave.appendChild(dCell);

                // Q
                const qCell = document.createElement('div');
                qCell.className = 'timing-cell ' + (h.q ? 'high' : 'low') + (isCurrent ? ' current' : '');
                qWave.appendChild(qCell);
            });
        }

        function reset() {
            animating = false;
            updateAnimBtn();
            d = 0;
            q = 0;
            history = [];
            const indicator = document.getElementById('clockIndicator');
            indicator.className = 'clock-indicator clock-low';
            document.getElementById('clockState').textContent = 'IDLE';
            document.getElementById('clockBtn').setAttribute('fill', '#4299e1');
            document.getElementById('wireClk').className.baseVal = 'wire off';
            updateDisplay();
            updateTimingDiagram();
        }

        async function animate() {
            if (animating) {
                animating = false;
                updateAnimBtn();
                return;
            }
            animating = true;
            updateAnimBtn();
            const sequence = [
                { setD: 0 }, { clock: true },
                { setD: 1 }, { clock: true },
                { setD: 1 }, { clock: true },
                { setD: 0 }, { clock: true },
                { setD: 1 }, { clock: true },
                { setD: 0 }, { clock: true },
            ];

            for (const action of sequence) {
                if (!animating) break;

                if (action.setD !== undefined) {
                    d = action.setD;
                    updateDisplay();
                    await new Promise(r => setTimeout(r, 500));
                }

                if (action.clock) {
                    await performClockPulse();
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            animating = false;
            updateAnimBtn();
        }

        function toggleConstruction() {
            document.getElementById('constructionContent').classList.toggle('open');
            document.getElementById('constructionToggle').classList.toggle('open');
        }

        // Initialize
        history.push({ clk: 'low', d: 0, q: 0 });
        updateDisplay();
        updateTimingDiagram();
    </script>
</body>
</html>
