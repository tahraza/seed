<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALU (Unite Arithmetique et Logique) - Animation Interactive</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .alu-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .control-group {
            background: #2d3748;
            padding: 15px;
            border-radius: 8px;
        }
        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #a0aec0;
            font-size: 14px;
        }
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #1a202c;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
        }
        .op-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .op-btn {
            padding: 8px 16px;
            border: 2px solid #4a5568;
            border-radius: 6px;
            background: #2d3748;
            color: #e2e8f0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .op-btn:hover {
            border-color: #4299e1;
        }
        .op-btn.active {
            border-color: #48bb78;
            background: #276749;
        }
        .result-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
            background: #1a202c;
            border-radius: 8px;
            margin-top: 20px;
        }
        .flags {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .flag {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }
        .flag.active {
            background: #48bb78;
            color: white;
        }
        .flag.inactive {
            background: #4a5568;
            color: #a0aec0;
        }
        .flag .flag-name {
            font-size: 18px;
            font-weight: bold;
        }
        .flag .flag-desc {
            font-size: 10px;
            opacity: 0.8;
        }
        .binary-display {
            font-size: 11px;
            color: #718096;
            margin-top: 5px;
        }
        .construction-section {
            margin-top: 30px;
            border: 2px solid #4a5568;
            border-radius: 12px;
            overflow: hidden;
        }
        .construction-header {
            background: #2d3748;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .construction-header:hover {
            background: #4a5568;
        }
        .construction-header h3 {
            margin: 0;
            color: #e2e8f0;
            font-size: 1.1rem;
        }
        .construction-toggle {
            color: #4299e1;
            font-size: 1.5rem;
            transition: transform 0.3s;
        }
        .construction-content {
            display: none;
            padding: 20px;
            background: #1a202c;
        }
        .construction-content.open {
            display: block;
        }
        .construction-toggle.open {
            transform: rotate(180deg);
        }
        .component-block {
            background: #2d3748;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4299e1;
        }
        .component-block h4 {
            margin: 0 0 10px 0;
            color: #e2e8f0;
            font-size: 1rem;
        }
        .component-block p {
            margin: 0;
            color: #a0aec0;
            font-size: 13px;
            line-height: 1.5;
        }
        .component-block.arith { border-left-color: #f6ad55; }
        .component-block.logic { border-left-color: #48bb78; }
        .component-block.control { border-left-color: #9f7aea; }
        .component-block.flags { border-left-color: #e53e3e; }
        .component-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .component-link {
            padding: 8px 16px;
            background: #4299e1;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.2s;
        }
        .component-link:hover {
            background: #3182ce;
        }
        .flags-explanation {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .flag-card {
            background: #2d3748;
            padding: 15px;
            border-radius: 8px;
            border-top: 3px solid #4a5568;
        }
        .flag-card.n { border-top-color: #e53e3e; }
        .flag-card.c { border-top-color: #f6ad55; }
        .flag-card.z { border-top-color: #48bb78; }
        .flag-card.v { border-top-color: #9f7aea; }
        .flag-card h4 {
            margin: 0 0 8px 0;
            color: #e2e8f0;
        }
        .flag-card p {
            margin: 0;
            color: #a0aec0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>ALU - Unite Arithmetique et Logique</h1>
    <p class="subtitle">Le coeur calculatoire du processeur</p>

    <div class="container">
        <svg class="circuit-svg" viewBox="0 0 520 320" xmlns="http://www.w3.org/2000/svg">
            <!-- ALU body (trapezoid shape) -->
            <path class="gate-body" d="M 150 50 L 350 80 L 350 220 L 150 250 L 150 180 L 180 150 L 150 120 Z"
                  fill="#2d3748" stroke="#4299e1" stroke-width="3"/>

            <!-- Input X wire -->
            <path id="wireX" class="wire on" d="M 50 100 L 150 100"/>

            <!-- Input Y wire -->
            <path id="wireY" class="wire on" d="M 50 200 L 150 200"/>

            <!-- Operation selector wire -->
            <path id="wireOp" class="wire on" d="M 250 300 L 250 250"/>

            <!-- Output wire -->
            <path id="wireOut" class="wire on" d="M 350 150 L 470 150"/>

            <!-- Input X indicator -->
            <g>
                <circle cx="50" cy="100" r="20" fill="#4299e1"/>
                <text x="50" y="105" text-anchor="middle" fill="white" font-weight="bold" font-size="12">X</text>
            </g>

            <!-- Input Y indicator -->
            <g>
                <circle cx="50" cy="200" r="20" fill="#48bb78"/>
                <text x="50" y="205" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Y</text>
            </g>

            <!-- Operation indicator -->
            <g>
                <circle cx="250" cy="300" r="18" fill="#f6ad55"/>
                <text id="opSymbol" x="250" y="305" text-anchor="middle" fill="white" font-weight="bold" font-size="14">+</text>
            </g>

            <!-- Output indicator -->
            <circle id="outputCircle" cx="470" cy="150" r="22" fill="#48bb78"/>
            <text id="outputText" x="470" y="155" text-anchor="middle" fill="white" font-weight="bold" font-size="14">OUT</text>

            <!-- Labels -->
            <text class="label" x="100" y="90" fill="#4299e1">X</text>
            <text class="label" x="100" y="210" fill="#48bb78">Y</text>
            <text class="label" x="250" y="290" fill="#f6ad55" text-anchor="middle">OP</text>
            <text class="label" x="470" y="120" fill="#63b3ed" text-anchor="middle">OUT</text>

            <!-- ALU label -->
            <text x="250" y="160" text-anchor="middle" fill="#e2e8f0" font-size="24" font-weight="bold">ALU</text>

            <!-- Flag outputs - NCZV -->
            <path class="wire off" id="wireN" d="M 350 90 L 400 70"/>
            <path class="wire off" id="wireC" d="M 350 105 L 400 95"/>
            <path class="wire off" id="wireZ" d="M 350 120 L 400 120"/>
            <path class="wire off" id="wireV" d="M 350 135 L 400 145"/>

            <!-- Flag indicators -->
            <g>
                <circle id="flagNCircle" cx="415" cy="70" r="12" fill="#4a5568"/>
                <text x="415" y="74" text-anchor="middle" fill="white" font-weight="bold" font-size="10">N</text>
            </g>
            <g>
                <circle id="flagCCircle" cx="415" cy="95" r="12" fill="#4a5568"/>
                <text x="415" y="99" text-anchor="middle" fill="white" font-weight="bold" font-size="10">C</text>
            </g>
            <g>
                <circle id="flagZCircle" cx="415" cy="120" r="12" fill="#4a5568"/>
                <text x="415" y="124" text-anchor="middle" fill="white" font-weight="bold" font-size="10">Z</text>
            </g>
            <g>
                <circle id="flagVCircle" cx="415" cy="145" r="12" fill="#4a5568"/>
                <text x="415" y="149" text-anchor="middle" fill="white" font-weight="bold" font-size="10">V</text>
            </g>

            <!-- Flag labels -->
            <text x="440" y="74" fill="#718096" font-size="9">Negative</text>
            <text x="440" y="99" fill="#718096" font-size="9">Carry</text>
            <text x="440" y="124" fill="#718096" font-size="9">Zero</text>
            <text x="440" y="149" fill="#718096" font-size="9">oVerflow</text>
        </svg>

        <div class="alu-controls">
            <div class="control-group">
                <label>Entree X (8-bit, -128 a 127)</label>
                <input type="number" id="inputX" value="5" min="-128" max="127" onchange="updateALU()">
                <div class="binary-display" id="binX">00000101</div>
            </div>
            <div class="control-group">
                <label>Entree Y (8-bit, -128 a 127)</label>
                <input type="number" id="inputY" value="3" min="-128" max="127" onchange="updateALU()">
                <div class="binary-display" id="binY">00000011</div>
            </div>
        </div>

        <div class="control-group">
            <label>Operation</label>
            <div class="op-buttons">
                <button class="op-btn active" data-op="add" onclick="setOp('add')">ADD (+)</button>
                <button class="op-btn" data-op="sub" onclick="setOp('sub')">SUB (-)</button>
                <button class="op-btn" data-op="and" onclick="setOp('and')">AND (&)</button>
                <button class="op-btn" data-op="or" onclick="setOp('or')">OR (|)</button>
                <button class="op-btn" data-op="xor" onclick="setOp('xor')">XOR (^)</button>
                <button class="op-btn" data-op="not" onclick="setOp('not')">NOT (~X)</button>
                <button class="op-btn" data-op="neg" onclick="setOp('neg')">NEG (-X)</button>
                <button class="op-btn" data-op="shl" onclick="setOp('shl')">SHL (&lt;&lt;)</button>
                <button class="op-btn" data-op="shr" onclick="setOp('shr')">SHR (&gt;&gt;)</button>
            </div>
        </div>

        <div class="result-display">
            <div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;">Resultat</div>
            <div style="font-size: 2rem;">
                <span id="resultX" style="color: #4299e1;">5</span>
                <span id="resultOp" style="color: #f6ad55;"> + </span>
                <span id="resultY" style="color: #48bb78;">3</span>
                <span style="color: #a0aec0;"> = </span>
                <span id="resultOut" style="color: #48bb78;">8</span>
            </div>
            <div class="binary-display" id="binOut">00001000</div>
        </div>

        <!-- NCZV Flags Display -->
        <div class="flags">
            <div class="flag inactive" id="flagN">
                <span class="flag-name">N</span>
                <span class="flag-desc">Negative</span>
            </div>
            <div class="flag inactive" id="flagC">
                <span class="flag-name">C</span>
                <span class="flag-desc">Carry</span>
            </div>
            <div class="flag inactive" id="flagZ">
                <span class="flag-name">Z</span>
                <span class="flag-desc">Zero</span>
            </div>
            <div class="flag inactive" id="flagV">
                <span class="flag-name">V</span>
                <span class="flag-desc">oVerflow</span>
            </div>
        </div>

        <!-- Flags Explanation -->
        <h3 style="text-align: center; margin-top: 30px; color: #a0aec0;">Flags NCZV</h3>
        <div class="flags-explanation">
            <div class="flag-card n">
                <h4>N - Negative</h4>
                <p>Actif si le resultat est negatif (bit de poids fort = 1 en complement a 2)</p>
            </div>
            <div class="flag-card c">
                <h4>C - Carry</h4>
                <p>Actif si une retenue sort du bit de poids fort (depassement non-signe)</p>
            </div>
            <div class="flag-card z">
                <h4>Z - Zero</h4>
                <p>Actif si le resultat est exactement zero</p>
            </div>
            <div class="flag-card v">
                <h4>V - oVerflow</h4>
                <p>Actif si depassement signe (ex: positif + positif = negatif)</p>
            </div>
        </div>

        <h3 style="text-align: center; margin-top: 30px; color: #a0aec0;">Operations de l'ALU</h3>
        <table class="truth-table">
            <thead>
                <tr>
                    <th>Operation</th>
                    <th>Code</th>
                    <th>Description</th>
                    <th>Formule</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>ADD</td><td>0000</td><td>Addition</td><td>X + Y</td></tr>
                <tr><td>SUB</td><td>0001</td><td>Soustraction</td><td>X - Y</td></tr>
                <tr><td>AND</td><td>0010</td><td>ET logique</td><td>X & Y</td></tr>
                <tr><td>OR</td><td>0011</td><td>OU logique</td><td>X | Y</td></tr>
                <tr><td>XOR</td><td>0100</td><td>OU exclusif</td><td>X ^ Y</td></tr>
                <tr><td>NOT</td><td>0101</td><td>Inversion</td><td>~X</td></tr>
                <tr><td>NEG</td><td>0110</td><td>Negation</td><td>-X (complement a 2)</td></tr>
                <tr><td>SHL</td><td>0111</td><td>Decalage gauche</td><td>X &lt;&lt; 1</td></tr>
                <tr><td>SHR</td><td>1000</td><td>Decalage droite</td><td>X &gt;&gt; 1</td></tr>
            </tbody>
        </table>

        <div class="controls">
            <button class="btn btn-secondary" onclick="reset()">Reset</button>
            <button id="animBtn" class="btn btn-primary" onclick="animate()">Demo Operations</button>
        </div>

        <!-- Construction Section -->
        <div class="construction-section">
            <div class="construction-header" onclick="toggleConstruction()">
                <h3>Voir la Construction</h3>
                <span class="construction-toggle" id="constructionToggle">&#9660;</span>
            </div>
            <div class="construction-content" id="constructionContent">
                <p style="color: #a0aec0; margin-bottom: 20px;">
                    L'ALU est un circuit complexe compose de plusieurs sous-unites. Voici ses composants principaux :
                </p>

                <!-- Architecture Diagram -->
                <svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg" style="max-width: 600px; margin: 0 auto 20px; display: block; background: #1a202c; border-radius: 8px;">
                    <!-- Input buses -->
                    <text x="30" y="80" fill="#4299e1" font-size="14" font-weight="bold">X[7:0]</text>
                    <path class="wire on" d="M 80 75 L 150 75" stroke-width="3"/>

                    <text x="30" y="320" fill="#48bb78" font-size="14" font-weight="bold">Y[7:0]</text>
                    <path class="wire on" d="M 80 315 L 150 315" stroke-width="3"/>

                    <!-- Arithmetic Unit -->
                    <rect x="150" y="40" width="140" height="120" rx="8" fill="#2d3748" stroke="#f6ad55" stroke-width="2"/>
                    <text x="220" y="70" text-anchor="middle" fill="#f6ad55" font-size="12" font-weight="bold">Unite Arithmetique</text>
                    <text x="220" y="95" text-anchor="middle" fill="#a0aec0" font-size="10">ADD16</text>
                    <text x="220" y="115" text-anchor="middle" fill="#a0aec0" font-size="10">SUB (via complement)</text>
                    <text x="220" y="135" text-anchor="middle" fill="#a0aec0" font-size="10">NEG, INC, DEC</text>

                    <!-- Logic Unit -->
                    <rect x="150" y="180" width="140" height="100" rx="8" fill="#2d3748" stroke="#48bb78" stroke-width="2"/>
                    <text x="220" y="210" text-anchor="middle" fill="#48bb78" font-size="12" font-weight="bold">Unite Logique</text>
                    <text x="220" y="235" text-anchor="middle" fill="#a0aec0" font-size="10">AND, OR, XOR, NOT</text>
                    <text x="220" y="255" text-anchor="middle" fill="#a0aec0" font-size="10">(portes logiques)</text>

                    <!-- Shift Unit -->
                    <rect x="150" y="300" width="140" height="60" rx="8" fill="#2d3748" stroke="#4299e1" stroke-width="2"/>
                    <text x="220" y="325" text-anchor="middle" fill="#4299e1" font-size="12" font-weight="bold">Unite Decalage</text>
                    <text x="220" y="345" text-anchor="middle" fill="#a0aec0" font-size="10">SHL, SHR, ROL, ROR</text>

                    <!-- MUX for result selection -->
                    <path d="M 340 100 L 340 300 L 400 250 L 400 150 Z" fill="#2d3748" stroke="#9f7aea" stroke-width="2"/>
                    <text x="365" y="205" text-anchor="middle" fill="#9f7aea" font-size="11" font-weight="bold">MUX</text>

                    <!-- Wires to MUX -->
                    <path class="wire on" d="M 290 100 L 340 175" stroke="#f6ad55"/>
                    <path class="wire on" d="M 290 230 L 340 200" stroke="#48bb78"/>
                    <path class="wire on" d="M 290 330 L 340 225" stroke="#4299e1"/>

                    <!-- Operation selector -->
                    <text x="370" y="320" text-anchor="middle" fill="#9f7aea" font-size="10">OP[3:0]</text>
                    <path class="wire on" d="M 370 305 L 370 260" stroke="#9f7aea"/>

                    <!-- Output from MUX -->
                    <path class="wire on" d="M 400 200 L 450 200" stroke-width="3"/>

                    <!-- Flags computation -->
                    <rect x="450" y="100" width="100" height="140" rx="8" fill="#2d3748" stroke="#e53e3e" stroke-width="2"/>
                    <text x="500" y="125" text-anchor="middle" fill="#e53e3e" font-size="11" font-weight="bold">Calcul Flags</text>
                    <text x="500" y="150" text-anchor="middle" fill="#a0aec0" font-size="10">N: bit[7]</text>
                    <text x="500" y="170" text-anchor="middle" fill="#a0aec0" font-size="10">C: carry out</text>
                    <text x="500" y="190" text-anchor="middle" fill="#a0aec0" font-size="10">Z: NOR(all bits)</text>
                    <text x="500" y="210" text-anchor="middle" fill="#a0aec0" font-size="10">V: overflow</text>

                    <!-- Flag outputs -->
                    <path class="wire on" d="M 550 130 L 580 130" stroke="#e53e3e"/>
                    <text x="590" y="134" fill="#e53e3e" font-size="10">N</text>
                    <path class="wire on" d="M 550 155 L 580 155" stroke="#f6ad55"/>
                    <text x="590" y="159" fill="#f6ad55" font-size="10">C</text>
                    <path class="wire on" d="M 550 180 L 580 180" stroke="#48bb78"/>
                    <text x="590" y="184" fill="#48bb78" font-size="10">Z</text>
                    <path class="wire on" d="M 550 205 L 580 205" stroke="#9f7aea"/>
                    <text x="590" y="209" fill="#9f7aea" font-size="10">V</text>

                    <!-- Result output -->
                    <text x="500" y="270" text-anchor="middle" fill="#48bb78" font-size="14" font-weight="bold">OUT[7:0]</text>
                    <path class="wire on" d="M 450 200 L 450 255 L 500 255" stroke-width="3" stroke="#48bb78"/>
                </svg>

                <!-- Component descriptions -->
                <div class="component-block arith">
                    <h4>Unite Arithmetique</h4>
                    <p>Basee sur l'<strong>ADD16</strong> (16 Full Adders en cascade). La soustraction utilise le complement a 2 : X - Y = X + (~Y) + 1.
                    Contient aussi les operations INC (X+1), DEC (X-1), et NEG (-X).</p>
                </div>

                <div class="component-block logic">
                    <h4>Unite Logique</h4>
                    <p>Operations bit-a-bit utilisant des portes <strong>AND</strong>, <strong>OR</strong>, <strong>XOR</strong> et <strong>NOT</strong>.
                    Chaque operation est effectuee en parallele sur tous les bits.</p>
                </div>

                <div class="component-block control">
                    <h4>Multiplexeur de Selection</h4>
                    <p>Un <strong>MUX</strong> selectionne le resultat selon le code operation.
                    Le signal OP[3:0] controle quelle unite fournit la sortie.</p>
                </div>

                <div class="component-block flags">
                    <h4>Calcul des Flags NCZV</h4>
                    <p><strong>N</strong>: Copie du bit 7 du resultat.<br>
                    <strong>C</strong>: Retenue de l'additionneur (carry out).<br>
                    <strong>Z</strong>: NOR de tous les bits (1 si tous sont 0).<br>
                    <strong>V</strong>: XOR des deux derniers carries (overflow signe).</p>
                </div>

                <div class="component-links">
                    <a href="add16.html" class="component-link">Voir ADD16</a>
                    <a href="full-adder.html" class="component-link">Voir Full Adder</a>
                    <a href="and.html" class="component-link">Voir AND</a>
                    <a href="or.html" class="component-link">Voir OR</a>
                    <a href="xor.html" class="component-link">Voir XOR</a>
                    <a href="mux.html" class="component-link">Voir MUX</a>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav" style="margin-top: 20px;">
        <a href="index.html">Index</a>
        <a href="full-adder.html">Additionneur Complet</a>
        <a href="add16.html">ADD16</a>
        <a href="register.html">Registre</a>
    </nav>

    <script>
        let currentOp = 'add';
        let animating = false;

        function updateAnimBtn() {
            const btn = document.getElementById('animBtn');
            btn.textContent = animating ? 'Stop' : 'Demo Operations';
            btn.classList.toggle('animating', animating);
        }

        function toBinary(n, bits = 8) {
            if (n < 0) {
                n = (1 << bits) + n;
            }
            return n.toString(2).padStart(bits, '0');
        }

        function toUnsigned(n, bits = 8) {
            if (n < 0) return (1 << bits) + n;
            return n;
        }

        function setOp(op) {
            currentOp = op;
            document.querySelectorAll('.op-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.op === op);
            });
            updateALU();
        }

        function compute(x, y, op) {
            switch(op) {
                case 'add': return { result: x + y, useY: true };
                case 'sub': return { result: x - y, useY: true };
                case 'and': return { result: x & y, useY: true };
                case 'or': return { result: x | y, useY: true };
                case 'xor': return { result: x ^ y, useY: true };
                case 'not': return { result: ~x, useY: false };
                case 'neg': return { result: -x, useY: false };
                case 'shl': return { result: x << 1, useY: false };
                case 'shr': return { result: x >> 1, useY: false };
                default: return { result: 0, useY: true };
            }
        }

        function getOpSymbol(op) {
            const symbols = {
                'add': '+', 'sub': '-', 'and': '&',
                'or': '|', 'xor': '^', 'not': '~', 'neg': '-',
                'shl': '<<', 'shr': '>>'
            };
            return symbols[op] || '?';
        }

        function updateALU() {
            const x = parseInt(document.getElementById('inputX').value) || 0;
            const y = parseInt(document.getElementById('inputY').value) || 0;
            const { result: rawResult, useY } = compute(x, y, currentOp);

            // Calculate flags before truncation
            const ux = toUnsigned(x);
            const uy = toUnsigned(y);

            // Carry flag - unsigned overflow for add/sub
            let carry = false;
            if (currentOp === 'add') {
                carry = (ux + uy) > 255;
            } else if (currentOp === 'sub') {
                carry = ux < uy; // Borrow
            } else if (currentOp === 'shl') {
                carry = (x & 0x80) !== 0; // MSB shifted out
            }

            // Handle 8-bit overflow (signed)
            let result = rawResult;
            if (result > 127) result = result - 256;
            if (result < -128) result = result + 256;

            // Flags
            const isZero = result === 0;
            const isNeg = result < 0;

            // Overflow: signed overflow
            let overflow = false;
            if (currentOp === 'add') {
                overflow = (x > 0 && y > 0 && result < 0) || (x < 0 && y < 0 && result > 0);
            } else if (currentOp === 'sub') {
                overflow = (x > 0 && y < 0 && result < 0) || (x < 0 && y > 0 && result > 0);
            }

            // Update display
            document.getElementById('binX').textContent = toBinary(x);
            document.getElementById('binY').textContent = toBinary(y);
            document.getElementById('binOut').textContent = toBinary(result);

            document.getElementById('resultX').textContent = x;
            document.getElementById('resultY').textContent = useY ? y : '';

            if (currentOp === 'shl' || currentOp === 'shr') {
                document.getElementById('resultOp').textContent = ' ' + getOpSymbol(currentOp) + ' 1 ';
            } else if (!useY) {
                document.getElementById('resultOp').textContent = getOpSymbol(currentOp);
            } else {
                document.getElementById('resultOp').textContent = ' ' + getOpSymbol(currentOp) + ' ';
            }
            document.getElementById('resultOut').textContent = result;

            document.getElementById('opSymbol').textContent = getOpSymbol(currentOp);

            // Update NCZV flags
            document.getElementById('flagN').className = 'flag ' + (isNeg ? 'active' : 'inactive');
            document.getElementById('flagC').className = 'flag ' + (carry ? 'active' : 'inactive');
            document.getElementById('flagZ').className = 'flag ' + (isZero ? 'active' : 'inactive');
            document.getElementById('flagV').className = 'flag ' + (overflow ? 'active' : 'inactive');

            // Update SVG flag indicators
            document.getElementById('flagNCircle').setAttribute('fill', isNeg ? '#e53e3e' : '#4a5568');
            document.getElementById('flagCCircle').setAttribute('fill', carry ? '#f6ad55' : '#4a5568');
            document.getElementById('flagZCircle').setAttribute('fill', isZero ? '#48bb78' : '#4a5568');
            document.getElementById('flagVCircle').setAttribute('fill', overflow ? '#9f7aea' : '#4a5568');

            document.getElementById('wireN').className.baseVal = 'wire ' + (isNeg ? 'on' : 'off');
            document.getElementById('wireC').className.baseVal = 'wire ' + (carry ? 'on' : 'off');
            document.getElementById('wireZ').className.baseVal = 'wire ' + (isZero ? 'on' : 'off');
            document.getElementById('wireV').className.baseVal = 'wire ' + (overflow ? 'on' : 'off');
        }

        function reset() {
            animating = false;
            updateAnimBtn();
            document.getElementById('inputX').value = 5;
            document.getElementById('inputY').value = 3;
            setOp('add');
        }

        async function animate() {
            if (animating) {
                animating = false;
                updateAnimBtn();
                return;
            }
            animating = true;
            updateAnimBtn();

            const ops = ['add', 'sub', 'and', 'or', 'xor', 'not', 'neg', 'shl', 'shr'];
            const testCases = [
                [5, 3],      // Simple
                [100, 50],   // Carry test
                [-5, 3],     // Negative
                [127, 1],    // Overflow
                [0, 0],      // Zero
                [-128, -1],  // Negative overflow
                [0b10101010, 0b01010101], // Binary patterns
            ];

            for (const [x, y] of testCases) {
                if (!animating) break;
                document.getElementById('inputX').value = x;
                document.getElementById('inputY').value = y;

                for (const op of ops) {
                    if (!animating) break;
                    setOp(op);
                    await new Promise(r => setTimeout(r, 600));
                }
            }
            animating = false;
            updateAnimBtn();
        }

        // Construction section
        function toggleConstruction() {
            const content = document.getElementById('constructionContent');
            const toggle = document.getElementById('constructionToggle');
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        // Initial update
        updateALU();
    </script>
</body>
</html>
