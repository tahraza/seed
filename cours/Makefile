# Seed Course - Makefile de g√©n√©ration
# G√©n√®re les slides HTML/PDF, TD et TP via Marp CLI

# =============================================================================
# CONFIGURATION
# =============================================================================

# Outil de g√©n√©ration (utilise npx pour √©viter installation globale)
MARP = npx @marp-team/marp-cli

# R√©pertoires
SRC_DIR = .
OUT_DIR = ../web/cours
THEME_DIR = _themes

# Liste des chapitres
CHAPTERS = 00_introduction \
           01_logique_booleenne \
           02_arithmetique \
           03_memoire \
           04_architecture \
           05_cpu \
           06_assembleur \
           07_compilateur

# Options Marp communes
# --html enables HTML tags for Mermaid diagrams and custom divs
MARP_OPTS = --allow-local-files --html

# =============================================================================
# TARGETS PRINCIPALES
# =============================================================================

.PHONY: all clean slides td tp eval help
.PHONY: ch00 ch01 ch02 ch03 ch04 ch05 ch06 ch07

# Target par d√©faut
all: slides td tp
	@echo "‚úÖ Build complet termin√©"

# Aide
help:
	@echo "Seed Course - Makefile"
	@echo ""
	@echo "Targets principales:"
	@echo "  make all      - G√©n√®re tout le contenu (slides, TD, TP)"
	@echo "  make slides   - G√©n√®re uniquement les slides HTML/PDF"
	@echo "  make td       - G√©n√®re uniquement les TD PDF"
	@echo "  make tp       - G√©n√®re uniquement les TP PDF"
	@echo "  make clean    - Supprime les fichiers g√©n√©r√©s"
	@echo ""
	@echo "Targets par chapitre:"
	@echo "  make ch00     - G√©n√®re le chapitre 00 (Introduction)"
	@echo "  make ch01     - G√©n√®re le chapitre 01 (Logique Bool√©enne)"
	@echo "  make ch02     - G√©n√®re le chapitre 02 (Arithm√©tique)"
	@echo "  make ch03     - G√©n√®re le chapitre 03 (M√©moire)"
	@echo "  make ch04     - G√©n√®re le chapitre 04 (Architecture)"
	@echo "  make ch05     - G√©n√®re le chapitre 05 (CPU)"
	@echo "  make ch06     - G√©n√®re le chapitre 06 (Assembleur)"

# Nettoyage
clean:
	@echo "üßπ Nettoyage des fichiers g√©n√©r√©s..."
	rm -rf $(OUT_DIR)
	@echo "‚úÖ Nettoyage termin√©"

# =============================================================================
# TARGETS PAR TYPE DE CONTENU
# =============================================================================

# G√©n√®re tous les slides HTML et PDF
slides: $(foreach ch,$(CHAPTERS),slides-$(ch))
	@echo "‚úÖ Tous les slides g√©n√©r√©s"

# G√©n√®re tous les TD PDF
td: $(foreach ch,$(CHAPTERS),td-$(ch))
	@echo "‚úÖ Tous les TD g√©n√©r√©s"

# G√©n√®re tous les TP PDF
tp: $(foreach ch,$(CHAPTERS),tp-$(ch))
	@echo "‚úÖ Tous les TP g√©n√©r√©s"

# =============================================================================
# TARGETS PAR CHAPITRE
# =============================================================================

ch00: slides-00_introduction td-00_introduction tp-00_introduction
	@echo "‚úÖ Chapitre 00 g√©n√©r√©"

ch01: slides-01_logique_booleenne hdl-01_logique_booleenne td-01_logique_booleenne tp-01_logique_booleenne
	@echo "‚úÖ Chapitre 01 g√©n√©r√©"

ch02: slides-02_arithmetique td-02_arithmetique tp-02_arithmetique
	@echo "‚úÖ Chapitre 02 g√©n√©r√©"

ch03: slides-03_memoire td-03_memoire tp-03_memoire
	@echo "‚úÖ Chapitre 03 g√©n√©r√©"

ch04: slides-04_architecture td-04_architecture tp-04_architecture
	@echo "‚úÖ Chapitre 04 g√©n√©r√©"

ch05: slides-05_cpu td-05_cpu tp-05_cpu
	@echo "‚úÖ Chapitre 05 g√©n√©r√©"

ch06: slides-06_assembleur asm-06_assembleur td-06_assembleur tp-06_assembleur
	@echo "‚úÖ Chapitre 06 g√©n√©r√©"

ch07: c32-07_compilateur
	@echo "‚úÖ Chapitre 07 g√©n√©r√©"

# =============================================================================
# R√àGLES DE G√âN√âRATION
# =============================================================================

# Pattern pour les slides d'un chapitre (HTML + PDF)
slides-%:
	@if [ -f "$*/01_slides.md" ]; then \
		echo "üìä G√©n√©ration slides $*..."; \
		mkdir -p $(OUT_DIR)/$*; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/slides.css \
			-o $(OUT_DIR)/$*/slides.html $*/01_slides.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) -o $(OUT_DIR)/$*/slides.html $*/01_slides.md; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/slides.css --pdf \
			-o $(OUT_DIR)/$*/slides.pdf $*/01_slides.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) --pdf -o $(OUT_DIR)/$*/slides.pdf $*/01_slides.md; \
	else \
		echo "‚è≠Ô∏è  Slides $* : fichier source manquant (01_slides.md)"; \
	fi

# Pattern pour les TD d'un chapitre (PDF uniquement)
td-%:
	@if [ -f "$*/02_td.md" ]; then \
		echo "üìù G√©n√©ration TD $*..."; \
		mkdir -p $(OUT_DIR)/$*; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/td.css --pdf \
			-o $(OUT_DIR)/$*/td.pdf $*/02_td.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) --pdf -o $(OUT_DIR)/$*/td.pdf $*/02_td.md; \
	else \
		echo "‚è≠Ô∏è  TD $* : fichier source manquant (02_td.md)"; \
	fi

# Pattern pour les TP d'un chapitre (PDF uniquement)
tp-%:
	@if [ -f "$*/03_tp.md" ]; then \
		echo "üîß G√©n√©ration TP $*..."; \
		mkdir -p $(OUT_DIR)/$*; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/tp.css --pdf \
			-o $(OUT_DIR)/$*/tp.pdf $*/03_tp.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) --pdf -o $(OUT_DIR)/$*/tp.pdf $*/03_tp.md; \
	else \
		echo "‚è≠Ô∏è  TP $* : fichier source manquant (03_tp.md)"; \
	fi

# Pattern pour les cours HDL (HTML + PDF)
hdl-%:
	@if [ -f "$*/05_hdl_slides.md" ]; then \
		echo "üíæ G√©n√©ration HDL $*..."; \
		mkdir -p $(OUT_DIR)/$*; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/slides.css \
			-o $(OUT_DIR)/$*/hdl.html $*/05_hdl_slides.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) -o $(OUT_DIR)/$*/hdl.html $*/05_hdl_slides.md; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/slides.css --pdf \
			-o $(OUT_DIR)/$*/hdl.pdf $*/05_hdl_slides.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) --pdf -o $(OUT_DIR)/$*/hdl.pdf $*/05_hdl_slides.md; \
	else \
		echo "‚è≠Ô∏è  HDL $* : fichier source manquant (05_hdl_slides.md)"; \
	fi

# Pattern pour les cours ASM (HTML + PDF)
asm-%:
	@if [ -f "$*/05_asm_slides.md" ]; then \
		echo "üîß G√©n√©ration ASM $*..."; \
		mkdir -p $(OUT_DIR)/$*; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/slides.css \
			-o $(OUT_DIR)/$*/asm.html $*/05_asm_slides.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) -o $(OUT_DIR)/$*/asm.html $*/05_asm_slides.md; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/slides.css --pdf \
			-o $(OUT_DIR)/$*/asm.pdf $*/05_asm_slides.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) --pdf -o $(OUT_DIR)/$*/asm.pdf $*/05_asm_slides.md; \
	else \
		echo "‚è≠Ô∏è  ASM $* : fichier source manquant (05_asm_slides.md)"; \
	fi

# Pattern pour les cours C32 (HTML + PDF)
c32-%:
	@if [ -f "$*/05_c32_slides.md" ]; then \
		echo "üìù G√©n√©ration C32 $*..."; \
		mkdir -p $(OUT_DIR)/$*; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/slides.css \
			-o $(OUT_DIR)/$*/c32.html $*/05_c32_slides.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) -o $(OUT_DIR)/$*/c32.html $*/05_c32_slides.md; \
		$(MARP) $(MARP_OPTS) --theme $(THEME_DIR)/slides.css --pdf \
			-o $(OUT_DIR)/$*/c32.pdf $*/05_c32_slides.md 2>/dev/null || \
		$(MARP) $(MARP_OPTS) --pdf -o $(OUT_DIR)/$*/c32.pdf $*/05_c32_slides.md; \
	else \
		echo "‚è≠Ô∏è  C32 $* : fichier source manquant (05_c32_slides.md)"; \
	fi

# =============================================================================
# √âVALUATIONS (pour Epic 3 et 6)
# =============================================================================

eval:
	@echo "üìã G√©n√©ration des √©valuations..."
	@mkdir -p $(OUT_DIR)/evaluations
	@for f in evaluations/*.md; do \
		if [ -f "$$f" ]; then \
			name=$$(basename "$$f" .md); \
			echo "  ‚Üí $$name.pdf"; \
			$(MARP) $(MARP_OPTS) --pdf -o $(OUT_DIR)/evaluations/$$name.pdf $$f 2>/dev/null || true; \
		fi; \
	done
	@echo "‚úÖ √âvaluations g√©n√©r√©es"
